<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DimTools - CSV Row Matcher</title>
    <!-- Load required libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url("https://unpkg.com/papercss@1.9.2/dist/paper.css");
        
        /* Navigation styling matching the template */
        li:has(~ .current)::after {
            content: "/";
            margin-inline-start: 10px;
        }

        li:has(~ li:not(a))::after {
            content: "/";
            margin-inline-start: 10px;
        }

        body {
            display: grid;
            place-items: center;
            min-height: 100vh;
            background-color: #f6eee3;
            background-size: 20px 20px;
            background-image: repeating-linear-gradient(0deg, #e5decf, #e5decf 1px, #f6eee3 1px, #f6eee3);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        ul {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        ul li::before {
            content: "";
        }
        
        /* Main container */
        .container {
            width: 100%;
            max-width: 1200px;
            min-height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* Upload area styling */
        .upload-area {
            background: white;
            border-radius: 5px;
            padding: 2rem;
            text-align: center;
            border: 2px dashed #8b4513;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1rem;
        }
        
        .upload-area:hover {
            background: #f9f5eb;
            border-color: #a0522d;
        }
        
        .upload-area.dragover {
            background: #f0e6d6;
            border-color: #8b4513;
            border-style: solid;
        }
        
        /* Configuration sections */
        .config-section {
            background: white;
            border-radius: 5px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            color: #8b4513;
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            border-bottom: 2px solid #e5decf;
            padding-bottom: 0.5rem;
        }
        
        .option-group {
            margin-bottom: 1.5rem;
        }
        
        .option-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #5d4037;
        }
        
        .option-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5decf;
            border-radius: 3px;
            font-family: inherit;
            font-size: 1rem;
        }
        
        .option-group input:focus {
            outline: none;
            border-color: #8b4513;
            background: #f9f5eb;
        }
        
        .hint {
            font-size: 0.85rem;
            color: #795548;
            margin-top: 0.5rem;
            font-style: italic;
        }
        
        /* Example boxes */
        .example-box {
            background: #fff9e6;
            border: 1px solid #ffd966;
            border-radius: 5px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .example-title {
            font-weight: bold;
            color: #d97706;
            margin-bottom: 0.5rem;
        }
        
        /* Info box */
        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-radius: 5px;
        }
        
        .info-box h3 {
            color: #667eea;
            margin-top: 0;
            margin-bottom: 0.75rem;
        }
        
        .info-box ul {
            display: block;
            margin-left: 1.5rem;
        }
        
        .info-box li {
            margin-bottom: 0.5rem;
        }
        
        /* Button groups */
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }
        
        .button-group button {
            flex: 1;
            min-width: 150px;
        }
        
        /* Status messages */
        .status-message {
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .status-message.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            display: block;
        }
        
        /* Results area */
        .results-area {
            background: white;
            border-radius: 5px;
            padding: 1.5rem;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .results-area.active {
            display: block;
        }
        
        .results-content {
            background: #f9f5eb;
            border: 1px solid #e5decf;
            border-radius: 5px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            margin-top: 1rem;
        }
        
        /* Download section */
        .download-section {
            background: white;
            border-radius: 5px;
            padding: 1.5rem;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 1.5rem;
            border: 2px solid #38a169;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .download-section.active {
            display: block;
        }
        
        .download-header {
            color: white;
            text-align: center;
            margin-bottom: 1.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .download-options {
            background: white;
            border-radius: 5px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .format-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #38a169;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            color: #2f855a;
            cursor: pointer;
            background: white;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 1rem;
            color: #666;
            font-size: 0.9rem;
            margin-top: 2rem;
            background: white;
            border-radius: 5px;
            border: 1px solid #e5decf;
        }
        
        .footer p {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
            font-style: italic;
        }
        
        /* Instructions */
        .instructions {
            background: white;
            border-radius: 5px;
            padding: 1.5rem;
            margin-top: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .instructions h3 {
            color: #8b4513;
            margin-top: 0;
        }
        
        .instructions ul {
            display: block;
            margin-left: 1.5rem;
        }
        
        .instructions li {
            margin-bottom: 0.5rem;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #8b4513;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                height: auto;
                min-height: calc(100vh - 120px);
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group button {
                width: 100%;
            }
            
            .upload-area {
                padding: 1.5rem;
            }
        }
        
        /* File name display */
        .file-name {
            display: inline-block;
            margin-left: 1rem;
            color: #5d4037;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div id="uploadArea" class="upload-area paper border shadow">
            <h2>ğŸ” CSV Row Matcher: Set-Valued Function Mapper</h2>
            <p>Find rows based on cell content and extract specific columns where row/column identifiers are merged into the table</p>
            <p><small>Drag & drop a CSV file here or click to browse</small></p>
            <input type="file" id="fileInput" accept=".csv" style="display: none;">
        </div>
        
        <div class="info-box">
            <h3>ğŸ“‹ How This Works</h3>
            <ul>
                <li>Upload your CSV file</li>
                <li>Specify which columns to search in (e.g., "R:BGB" or "A,C,D")</li>
                <li>Enter the text value to search for (e.g., "HAS", "Yes", "Active")</li>
                <li>Choose which columns you want to see in the output</li>
                <li><strong>NEW:</strong> Shows ALL matching headers for each row where value appears</li>
                <li><strong>NEW:</strong> Output format: [Row Identifier], [Header1], [Header2], ...</li>
            </ul>
        </div>
        
        <div class="config-section paper border shadow">
            <h3 class="section-title">1. Upload CSV File</h3>
            <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                ğŸ“ Choose CSV File
            </button>
            <span id="fileName" class="file-name">No file selected</span>
        </div>
        
        <div class="config-section paper border shadow">
            <h3 class="section-title">2. Configure Search</h3>
            
            <div class="option-group">
                <label for="columnRange">Column Range to Search In:</label>
                <input type="text" id="columnRange" placeholder="e.g., R:BGB or A,C,E,F or D:Z">
                <div class="hint">Use ":" for ranges (A:Z) or commas for specific columns (A,B,C)</div>
                
                <div class="example-box">
                    <div class="example-title">Examples:</div>
                    <div>â€¢ <code>R:BGB</code> - Search in columns R through BGB</div>
                    <div>â€¢ <code>A,C,D</code> - Search only in columns A, C, and D</div>
                    <div>â€¢ <code>B:F</code> - Search in columns B through F</div>
                </div>
            </div>
            
            <div class="option-group">
                <label for="searchValue">Search For This Value:</label>
                <input type="text" id="searchValue" placeholder="e.g., HAS, Yes, Active, TRUE">
                <div class="hint">Case-insensitive search</div>
            </div>
        </div>
        
        <div class="config-section paper border shadow">
            <h3 class="section-title">3. Choose Output Columns</h3>
            
            <div class="option-group">
                <label for="outputColumns">Columns to Display in Results:</label>
                <input type="text" id="outputColumns" placeholder="e.g., A or A,B,C">
                <div class="hint">First column will be used as the row identifier. Example: "A" uses Column A values as identifiers</div>
                
                <div class="example-box">
                    <div class="example-title">Example Output Format:</div>
                    <div><strong>Input:</strong> Burger, 1, 0, 1, 1</div>
                    <div><strong>Searching for "1" in columns B:E</strong></div>
                    <div><strong>Output:</strong> Burger, HasGluten, HasDairy, HasEggs</div>
                    <div style="margin-top: 0.5rem; color: #666;">(Shows row identifier + all header names where value was found)</div>
                </div>
            </div>
        </div>
        
        <div class="button-group">
            <button class="btn-primary" onclick="processCSV()">ğŸš€ Process CSV</button>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
        
        <div id="resultsArea" class="results-area">
            <h3 class="section-title">ğŸ“Š Results Preview</h3>
            <div class="results-content" id="resultsContent"></div>
        </div>
        
        <div id="downloadSection" class="download-section">
            <div class="download-header">
                <h3>â¬‡ï¸ 4. DOWNLOAD YOUR RESULTS â¬‡ï¸</h3>
                <p>ğŸ“ Choose Your Download Format:</p>
            </div>
            
            <div class="download-options">
                <select id="formatSelect" class="format-select">
                    <option value="txt">ğŸ“„ TXT - Plain Text</option>
                    <option value="csv">ğŸ“Š CSV - Comma Separated Values</option>
                    <option value="json">ğŸ”§ JSON - JavaScript Object Notation</option>
                    <option value="xlsx">ğŸ“ˆ XLSX - Excel Spreadsheet</option>
                    <option value="pdf">ğŸ“• PDF - Portable Document Format</option>
                </select>
                
                <div style="margin-top: 1.5rem; text-align: center;">
                    <button class="btn-secondary" onclick="downloadResults()" style="font-size: 1.1rem; padding: 1rem 2rem;">
                        ğŸ’¾ DOWNLOAD NOW
                    </button>
                </div>
            </div>
        </div>
        
        <div class="instructions paper border shadow">
            <h3>About This Tool</h3>
            <p>This tool addresses a fundamental but overlooked data problem: spreadsheets forced to act as entire relational databases within a single table. When complex information gets flattened into a grid, the meaning of the dataâ€”what the rows and columns representâ€”gets embedded within the data itself, typically with column headers in Row 1.</p>
            <p>This application helps you navigate that structure. It locates all cells matching your search term and intelligently retrieves the proper identifiers: the value from your specified row (like an item name) and the corresponding column header (like a property or category) for every match. It outputs these paired results in your choice of cleanly formatted PDF, CSV, JSON, XLSX, or TXT files.</p>
            <p>The entire process is secure and private. All parsing, searching, and file generation happens client-side in your browser. No data is ever sent to a serverâ€”it never leaves your machine. You get the power of a data processing utility with the absolute privacy of a local application. The code is open for inspection, confirming that no data or metadata is ever collected or transmitted. -Dimitry III</p>
        </div>
        
        <div class="footer">
            <p>DimTools - CSV Row Matcher | All data processing happens locally in your browser</p>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <h3>Processing CSV file...</h3>
        <p>Searching for matches and analyzing data</p>
    </div>

    <script>
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const fileName = document.getElementById('fileName');
        const statusMessage = document.getElementById('statusMessage');
        const resultsArea = document.getElementById('resultsArea');
        const resultsContent = document.getElementById('resultsContent');
        const downloadSection = document.getElementById('downloadSection');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // State variables
        let resultsData = '';
        let matchedRows = [];
        let currentFile = null;
        let headers = [];
        
        // Event Listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                currentFile = e.target.files[0];
                fileName.textContent = 'âœ“ ' + currentFile.name;
                showStatus(`Ready to process: ${currentFile.name}`, 'success');
            }
        });
        
        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.name.match(/\.csv$/i)) {
                    currentFile = file;
                    fileName.textContent = 'âœ“ ' + file.name;
                    showStatus(`Ready to process: ${file.name}`, 'success');
                } else {
                    showStatus('âŒ Please upload a CSV file', 'error');
                }
            }
        });
        
        // Column letter to index conversion
        function columnToIndex(col) {
            col = col.toUpperCase();
            let index = 0;
            for (let i = 0; i < col.length; i++) {
                index = index * 26 + (col.charCodeAt(i) - 64);
            }
            return index - 1;
        }
        
        // Parse column range string
        function parseColumnRange(rangeStr) {
            rangeStr = rangeStr.trim().toUpperCase();
            let columns = [];
            
            if (rangeStr.includes(':')) {
                let [start, end] = rangeStr.split(':');
                let startIdx = columnToIndex(start);
                let endIdx = columnToIndex(end);
                for (let i = startIdx; i <= endIdx; i++) {
                    columns.push(i);
                }
            } else if (rangeStr.includes(',')) {
                let cols = rangeStr.split(',');
                cols.forEach(col => {
                    columns.push(columnToIndex(col.trim()));
                });
            } else {
                columns.push(columnToIndex(rangeStr));
            }
            
            return columns;
        }
        
        // Show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
        }
        
        // Process CSV file
        function processCSV() {
            if (!currentFile) {
                showStatus('âŒ Please select a CSV file first!', 'error');
                return;
            }
            
            const columnRange = document.getElementById('columnRange').value;
            const searchValue = document.getElementById('searchValue').value;
            const outputColumns = document.getElementById('outputColumns').value;
            
            if (!columnRange || !searchValue || !outputColumns) {
                showStatus('âŒ Please fill in all fields!', 'error');
                return;
            }
            
            // Show loading overlay
            loadingOverlay.classList.add('active');
            showStatus('â³ Processing your CSV file...', 'processing');
            
            // Hide previous results
            resultsArea.classList.remove('active');
            downloadSection.classList.remove('active');
            
            Papa.parse(currentFile, {
                complete: function(results) {
                    try {
                        const rows = results.data;
                        headers = rows[0];
                        
                        const searchColumns = parseColumnRange(columnRange);
                        const displayColumns = parseColumnRange(outputColumns);
                        const searchTerm = searchValue.trim().toUpperCase();
                        
                        // Create formatted output
                        let output = 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
                        output += 'â•‘                     CSV ANALYSIS RESULTS                      â•‘\n';
                        output += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
                        output += `â•‘ File: ${currentFile.name.padEnd(55)} â•‘\n`;
                        output += `â•‘ Total Rows: ${(rows.length - 1).toString().padEnd(50)} â•‘\n`;
                        output += `â•‘ Search Columns: ${columnRange.padEnd(47)} â•‘\n`;
                        output += `â•‘ Search Value: "${searchValue}"${' '.repeat(57 - searchValue.length - 2)}â•‘\n`;
                        output += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
                        output += 'â•‘                        MATCHING ROWS                         â•‘\n';
                        output += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
                        
                        let matchCount = 0;
                        matchedRows = [];
                        
                        // Process each data row
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            let matchedHeaders = [];
                            
                            // Check ALL search columns for matches
                            for (let colIdx of searchColumns) {
                                if (colIdx < row.length) {
                                    const cell = row[colIdx];
                                    // Check if cell exists and matches search term
                                    if (cell && cell.toString().trim().toUpperCase() === searchTerm) {
                                        // Get the header from row 1 for this column
                                        if (colIdx < headers.length) {
                                            matchedHeaders.push(headers[colIdx] || `Column ${colIdx + 1}`);
                                        } else {
                                            matchedHeaders.push(`Column ${colIdx + 1}`);
                                        }
                                    }
                                }
                            }
                            
                            // If we found ANY matches in this row
                            if (matchedHeaders.length > 0) {
                                matchCount++;
                                
                                // Get the row identifier from first display column
                                let rowIdentifier = '';
                                if (displayColumns.length > 0 && displayColumns[0] < row.length) {
                                    rowIdentifier = row[displayColumns[0]] || '(empty)';
                                } else if (displayColumns.length > 0) {
                                    rowIdentifier = `Row ${i + 1}`;
                                }
                                
                                // Build the output line
                                output += `â•‘ ${rowIdentifier}`;
                                
                                // Add matched headers
                                if (matchedHeaders.length > 0) {
                                    const headerStr = matchedHeaders.join(', ');
                                    output += `\nâ•‘   â†’ ${headerStr}`;
                                }
                                
                                output += '\nâ•‘\n';
                                
                                // Store structured data for export
                                let rowData = {
                                    rowNumber: i + 1,
                                    identifier: rowIdentifier,
                                    matchedHeaders: matchedHeaders,
                                    // Store all display column values
                                    displayData: {}
                                };
                                
                                // Store all display column values
                                for (let colIdx of displayColumns) {
                                    if (colIdx < row.length && colIdx < headers.length) {
                                        const columnName = headers[colIdx] || `Column ${colIdx + 1}`;
                                        const cellValue = row[colIdx] || '(empty)';
                                        rowData.displayData[columnName] = cellValue;
                                    }
                                }
                                
                                matchedRows.push(rowData);
                            }
                        }
                        
                        // Add footer with summary
                        output += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
                        output += 'â•‘                          SUMMARY                            â•‘\n';
                        output += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
                        output += `â•‘ Total Matching Rows: ${matchCount.toString().padEnd(42)} â•‘\n`;
                        output += `â•‘ Format: [Row Identifier], [Matched Header1], [Header2], ... â•‘\n`;
                        output += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
                        
                        resultsData = output;
                        resultsContent.textContent = output;
                        
                        // Show results and download section
                        resultsArea.classList.add('active');
                        downloadSection.classList.add('active');
                        
                        showStatus(`âœ… Success! Found ${matchCount} matching rows with ${matchedRows.reduce((total, row) => total + row.matchedHeaders.length, 0)} total matches.`, 'success');
                        
                    } catch (error) {
                        showStatus(`âŒ Error: ${error.message}`, 'error');
                    } finally {
                        loadingOverlay.classList.remove('active');
                    }
                },
                error: function(error) {
                    showStatus(`âŒ Failed to parse CSV: ${error.message}`, 'error');
                    loadingOverlay.classList.remove('active');
                }
            });
        }
        
        // Download results in selected format
        function downloadResults() {
            const format = document.getElementById('formatSelect').value;
            
            switch(format) {
                case 'txt':
                    downloadTXT();
                    break;
                case 'csv':
                    downloadCSV();
                    break;
                case 'json':
                    downloadJSON();
                    break;
                case 'xlsx':
                    downloadXLSX();
                    break;
                case 'pdf':
                    downloadPDF();
                    break;
            }
        }
        
        // Download as TXT
        function downloadTXT() {
            const blob = new Blob([resultsData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'csv_match_results.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Download as CSV
        function downloadCSV() {
            if (matchedRows.length === 0) {
                showStatus('âŒ No data to download', 'error');
                return;
            }
            
            // Create CSV with row identifier and matched headers
            let csvContent = 'Row Identifier,Matched Headers\n';
            
            matchedRows.forEach(row => {
                let escapedIdentifier = row.identifier.toString().includes(',') ? 
                    `"${row.identifier.replace(/"/g, '""')}"` : row.identifier;
                
                let escapedHeaders = row.matchedHeaders.length > 0 ?
                    `"${row.matchedHeaders.join(', ').replace(/"/g, '""')}"` : '';
                
                csvContent += `${escapedIdentifier},${escapedHeaders}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'csv_match_results.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Download as JSON
        function downloadJSON() {
            const jsonData = {
                metadata: {
                    file: currentFile.name,
                    searchValue: document.getElementById('searchValue').value,
                    searchColumns: document.getElementById('columnRange').value,
                    outputColumns: document.getElementById('outputColumns').value,
                    totalMatchingRows: matchedRows.length,
                    totalMatches: matchedRows.reduce((total, row) => total + row.matchedHeaders.length, 0)
                },
                results: matchedRows
            };
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'csv_match_results.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Download as XLSX
        function downloadXLSX() {
            if (matchedRows.length === 0) {
                showStatus('âŒ No data to download', 'error');
                return;
            }
            
            // Create worksheet data
            const wsData = [
                ['Row Identifier', 'Matched Headers']
            ];
            
            matchedRows.forEach(row => {
                wsData.push([
                    row.identifier,
                    row.matchedHeaders.join(', ')
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Match Results');
            
            XLSX.writeFile(wb, 'csv_match_results.xlsx');
        }
        
        // Download as PDF
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = 20;
            
            // Header
            doc.setFontSize(18);
            doc.text('CSV Match Results', margin, y);
            y += 10;
            
            doc.setFontSize(10);
            doc.text(`File: ${currentFile.name}`, margin, y);
            y += 7;
            doc.text(`Search Value: ${document.getElementById('searchValue').value}`, margin, y);
            y += 7;
            doc.text(`Total Rows with Matches: ${matchedRows.length}`, margin, y);
            y += 15;
            
            // Results
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Results:', margin, y);
            y += 10;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            matchedRows.forEach((row, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                    doc.setFontSize(9);
                }
                
                // Row identifier
                doc.setFont(undefined, 'bold');
                doc.text(`${row.identifier}:`, margin, y);
                y += 5;
                
                // Matched headers
                doc.setFont(undefined, 'normal');
                if (row.matchedHeaders.length > 0) {
                    const headerText = row.matchedHeaders.join(', ');
                    const lines = doc.splitTextToSize(headerText, pageWidth - 2 * margin);
                    lines.forEach(line => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                            doc.setFontSize(9);
                        }
                        doc.text(`  ${line}`, margin + 5, y);
                        y += 5;
                    });
                }
                y += 8;
            });
            
            doc.save('csv_match_results.pdf');
        }
    </script>
</body>
</html>
