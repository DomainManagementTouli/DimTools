<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DimTools - Rich Text Editor</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/papercss@1.9.2/dist/paper.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e8edf6;
            background-size: 20px 20px;
            background-image: repeating-linear-gradient(0deg, #cfd5e5, #cfd5e5 1px, #e8edf6 1px, #e8edf6);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* ── Top Menu Bar ── */
        .menu-bar {
            background: white;
            border-bottom: 1px solid #ddd;
            padding: 4px 12px 4px 60px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .menu-bar .doc-icon { font-size: 28px; color: #1a3c8b; }
        .menu-bar .doc-info { flex: 1; }
        .doc-title-input {
            border: none;
            font-size: 17px;
            font-weight: 600;
            color: #333;
            background: transparent;
            outline: none;
            width: 300px;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .doc-title-input:hover, .doc-title-input:focus {
            border: 1px solid #c0c0c0;
            margin: -1px;
        }
        .top-menus {
            display: flex;
            gap: 2px;
            margin-top: 2px;
        }
        .top-menu-btn {
            background: none;
            border: none;
            padding: 2px 8px;
            font-size: 13px;
            color: #444;
            cursor: pointer;
            border-radius: 4px;
        }
        .top-menu-btn:hover { background: #e8edf6; }
        .save-indicator {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
        }

        /* ── Toolbar ── */
        .toolbar {
            background: #f0f3f9;
            border-bottom: 1px solid #ddd;
            padding: 4px 8px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 2px;
            flex-shrink: 0;
        }
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 1px;
            padding: 0 4px;
            border-right: 1px solid #d0d0d0;
        }
        .toolbar-group:last-child { border-right: none; }

        .tb {
            background: none;
            border: 1px solid transparent;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            color: #444;
            position: relative;
        }
        .tb:hover { background: #dce3f0; }
        .tb.active { background: #c8d4ea; border-color: #a0b0d0; }

        .tb select, .toolbar select {
            height: 28px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
            padding: 0 4px;
            background: white;
            cursor: pointer;
            outline: none;
        }
        .toolbar select:hover { border-color: #1a3c8b; }

        .tb input[type="color"] {
            width: 22px;
            height: 22px;
            border: none;
            padding: 0;
            cursor: pointer;
            background: transparent;
        }

        .font-select { width: 140px; }
        .size-select { width: 55px; }
        .heading-select { width: 110px; }

        /* ── Ruler ── */
        .ruler-container {
            background: white;
            height: 22px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: flex-end;
            padding-left: 80px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .ruler {
            height: 20px;
            position: relative;
            width: 100%;
        }
        .ruler-tick {
            position: absolute;
            bottom: 0;
            width: 1px;
            background: #aaa;
        }
        .ruler-label {
            position: absolute;
            bottom: 8px;
            font-size: 9px;
            color: #888;
            transform: translateX(-50%);
        }

        /* ── Editor Area ── */
        .editor-wrapper {
            flex: 1;
            overflow-y: auto;
            background: #d0d5dd;
            display: flex;
            justify-content: center;
            padding: 20px 10px;
        }
        .page-container {
            width: 816px; /* 8.5in at 96dpi */
            min-height: 1056px; /* 11in at 96dpi */
            background: white;
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
            padding: 96px 96px; /* 1 inch margins default */
            outline: none;
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #000;
            position: relative;
            cursor: text;
        }
        .page-container:focus {
            outline: none;
        }
        .page-container:empty::before {
            content: 'Start typing your document...';
            color: #bbb;
            font-style: italic;
            pointer-events: none;
        }
        .page-container img {
            max-width: 100%;
            cursor: pointer;
        }
        .page-container table {
            border-collapse: collapse;
            width: 100%;
            margin: 8px 0;
        }
        .page-container td, .page-container th {
            border: 1px solid #ccc;
            padding: 6px 8px;
            min-width: 40px;
        }

        /* ── Status Bar ── */
        .status-bar {
            background: white;
            border-top: 1px solid #ddd;
            padding: 4px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #666;
            flex-shrink: 0;
        }
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .zoom-controls button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .zoom-controls button:hover { background: #eee; }
        .zoom-controls input[type="range"] { width: 100px; }

        /* ── Dropdown Menus ── */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            min-width: 220px;
            padding: 4px 0;
            z-index: 1000;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 16px;
            font-size: 13px;
            color: #333;
            cursor: pointer;
            white-space: nowrap;
        }
        .dropdown-item:hover { background: #e8edf6; }
        .dropdown-item .shortcut { color: #999; font-size: 12px; }
        .dropdown-divider { height: 1px; background: #eee; margin: 4px 0; }

        /* ── Find & Replace Bar ── */
        .find-bar {
            display: none;
            background: white;
            border-bottom: 1px solid #ddd;
            padding: 6px 12px;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .find-bar.show { display: flex; flex-wrap: wrap; }
        .find-bar input {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            width: 200px;
        }
        .find-bar button {
            background: #1a3c8b;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .find-bar button:hover { background: #2952a3; }
        .find-bar button.secondary { background: #888; }
        .find-bar .close-find { background: none; color: #666; font-size: 18px; padding: 2px 8px; }

        /* ── Toast Notifications ── */
        .toast {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 13px;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .toast.show { opacity: 1; }

        /* ── Responsive ── */
        @media (max-width: 900px) {
            .page-container {
                width: 100%;
                min-height: auto;
                padding: 48px;
            }
            .editor-wrapper { padding: 10px 4px; }
            .menu-bar { padding-left: 50px; }
            .doc-title-input { width: 180px; }
        }
    </style>
</head>
<body>
<script src="nav-box.js"></script>

<!-- Menu Bar -->
<div class="menu-bar">
    <i class="fa-solid fa-file-lines doc-icon"></i>
    <div class="doc-info">
        <input type="text" class="doc-title-input" id="docTitle" value="Untitled Document" spellcheck="false">
        <div class="top-menus">
            <div style="position:relative">
                <button class="top-menu-btn" data-menu="file">File</button>
                <div class="dropdown-menu" id="menu-file">
                    <div class="dropdown-item" onclick="newDocument()">
                        <span><i class="fa-solid fa-file"></i> New</span><span class="shortcut">Ctrl+Alt+N</span>
                    </div>
                    <div class="dropdown-item" onclick="openFile()">
                        <span><i class="fa-solid fa-folder-open"></i> Open</span><span class="shortcut">Ctrl+O</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="manualSave()">
                        <span><i class="fa-solid fa-floppy-disk"></i> Save to Cache</span><span class="shortcut">Ctrl+S</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="downloadAs('pdf')">
                        <span><i class="fa-solid fa-file-pdf"></i> Download as PDF</span>
                    </div>
                    <div class="dropdown-item" onclick="downloadAs('txt')">
                        <span><i class="fa-solid fa-file-lines"></i> Download as TXT</span>
                    </div>
                    <div class="dropdown-item" onclick="downloadAs('doc')">
                        <span><i class="fa-solid fa-file-word"></i> Download as DOC</span>
                    </div>
                    <div class="dropdown-item" onclick="downloadAs('docx')">
                        <span><i class="fa-solid fa-file-word"></i> Download as DOCX</span>
                    </div>
                    <div class="dropdown-item" onclick="downloadAs('rtf')">
                        <span><i class="fa-solid fa-file"></i> Download as RTF</span>
                    </div>
                    <div class="dropdown-item" onclick="downloadAs('html')">
                        <span><i class="fa-solid fa-file-code"></i> Download as HTML</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="printDoc()">
                        <span><i class="fa-solid fa-print"></i> Print</span><span class="shortcut">Ctrl+P</span>
                    </div>
                </div>
            </div>
            <div style="position:relative">
                <button class="top-menu-btn" data-menu="edit">Edit</button>
                <div class="dropdown-menu" id="menu-edit">
                    <div class="dropdown-item" onclick="document.execCommand('undo')">
                        <span><i class="fa-solid fa-rotate-left"></i> Undo</span><span class="shortcut">Ctrl+Z</span>
                    </div>
                    <div class="dropdown-item" onclick="document.execCommand('redo')">
                        <span><i class="fa-solid fa-rotate-right"></i> Redo</span><span class="shortcut">Ctrl+Y</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="document.execCommand('cut')">
                        <span><i class="fa-solid fa-scissors"></i> Cut</span><span class="shortcut">Ctrl+X</span>
                    </div>
                    <div class="dropdown-item" onclick="document.execCommand('copy')">
                        <span><i class="fa-solid fa-copy"></i> Copy</span><span class="shortcut">Ctrl+C</span>
                    </div>
                    <div class="dropdown-item" onclick="document.execCommand('paste')">
                        <span><i class="fa-solid fa-paste"></i> Paste</span><span class="shortcut">Ctrl+V</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="document.execCommand('selectAll')">
                        <span><i class="fa-solid fa-object-group"></i> Select All</span><span class="shortcut">Ctrl+A</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="toggleFindBar()">
                        <span><i class="fa-solid fa-magnifying-glass"></i> Find & Replace</span><span class="shortcut">Ctrl+H</span>
                    </div>
                </div>
            </div>
            <div style="position:relative">
                <button class="top-menu-btn" data-menu="insert">Insert</button>
                <div class="dropdown-menu" id="menu-insert">
                    <div class="dropdown-item" onclick="insertImage()">
                        <span><i class="fa-solid fa-image"></i> Image</span>
                    </div>
                    <div class="dropdown-item" onclick="insertLink()">
                        <span><i class="fa-solid fa-link"></i> Link</span><span class="shortcut">Ctrl+K</span>
                    </div>
                    <div class="dropdown-item" onclick="insertHR()">
                        <span><i class="fa-solid fa-minus"></i> Horizontal Line</span>
                    </div>
                    <div class="dropdown-item" onclick="insertTable()">
                        <span><i class="fa-solid fa-table"></i> Table</span>
                    </div>
                    <div class="dropdown-item" onclick="insertDate()">
                        <span><i class="fa-solid fa-calendar"></i> Date</span>
                    </div>
                    <div class="dropdown-item" onclick="insertSpecialChar()">
                        <span><i class="fa-solid fa-omega"></i> Special Character</span>
                    </div>
                    <div class="dropdown-item" onclick="insertPageBreak()">
                        <span><i class="fa-solid fa-file-export"></i> Page Break</span>
                    </div>
                </div>
            </div>
            <div style="position:relative">
                <button class="top-menu-btn" data-menu="format">Format</button>
                <div class="dropdown-menu" id="menu-format">
                    <div class="dropdown-item" onclick="clearFormatting()">
                        <span><i class="fa-solid fa-eraser"></i> Clear Formatting</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="setPageBg()">
                        <span><i class="fa-solid fa-fill-drip"></i> Page Background Color</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="toggleSpellCheck()">
                        <span><i class="fa-solid fa-spell-check"></i> Toggle Spellcheck</span>
                    </div>
                </div>
            </div>
            <div style="position:relative">
                <button class="top-menu-btn" data-menu="view">View</button>
                <div class="dropdown-menu" id="menu-view">
                    <div class="dropdown-item" onclick="toggleRuler()">
                        <span><i class="fa-solid fa-ruler-horizontal"></i> Toggle Ruler</span>
                    </div>
                    <div class="dropdown-item" onclick="toggleFullscreen()">
                        <span><i class="fa-solid fa-expand"></i> Fullscreen</span><span class="shortcut">F11</span>
                    </div>
                    <div class="dropdown-item" onclick="toggleDarkMode()">
                        <span><i class="fa-solid fa-moon"></i> Dark Mode</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <span class="save-indicator" id="saveIndicator">All changes saved</span>
</div>

<!-- Find & Replace Bar -->
<div class="find-bar" id="findBar">
    <input type="text" id="findInput" placeholder="Find...">
    <input type="text" id="replaceInput" placeholder="Replace with...">
    <button onclick="findText()">Find</button>
    <button onclick="replaceText()">Replace</button>
    <button onclick="replaceAllText()">Replace All</button>
    <button class="close-find" onclick="toggleFindBar()">&times;</button>
</div>

<!-- Toolbar -->
<div class="toolbar">
    <!-- Undo / Redo -->
    <div class="toolbar-group">
        <button class="tb" onclick="exec('undo')" title="Undo"><i class="fa-solid fa-rotate-left"></i></button>
        <button class="tb" onclick="exec('redo')" title="Redo"><i class="fa-solid fa-rotate-right"></i></button>
    </div>

    <!-- Heading / Font / Size -->
    <div class="toolbar-group">
        <select class="heading-select" id="headingSelect" onchange="applyHeading(this.value)" title="Paragraph style">
            <option value="">Normal text</option>
            <option value="1">Heading 1</option>
            <option value="2">Heading 2</option>
            <option value="3">Heading 3</option>
            <option value="4">Heading 4</option>
            <option value="5">Heading 5</option>
            <option value="6">Heading 6</option>
        </select>
        <select class="font-select" id="fontSelect" onchange="applyFont(this.value)" title="Font family">
            <option value="Arial">Arial</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Georgia">Georgia</option>
            <option value="Courier New">Courier New</option>
            <option value="Verdana">Verdana</option>
            <option value="Trebuchet MS">Trebuchet MS</option>
            <option value="Comic Sans MS">Comic Sans MS</option>
            <option value="Impact">Impact</option>
            <option value="Lucida Console">Lucida Console</option>
            <option value="Tahoma">Tahoma</option>
            <option value="Palatino Linotype">Palatino Linotype</option>
            <option value="Garamond">Garamond</option>
            <option value="Brush Script MT">Brush Script MT</option>
        </select>
        <select class="size-select" id="sizeSelect" onchange="applyFontSize(this.value)" title="Font size">
            <option value="1">8</option>
            <option value="2">10</option>
            <option value="3" selected>12</option>
            <option value="4">14</option>
            <option value="5">18</option>
            <option value="6">24</option>
            <option value="7">36</option>
        </select>
    </div>

    <!-- Basic Formatting -->
    <div class="toolbar-group">
        <button class="tb" onclick="exec('bold')" title="Bold (Ctrl+B)" id="btn-bold"><b>B</b></button>
        <button class="tb" onclick="exec('italic')" title="Italic (Ctrl+I)" id="btn-italic"><i>I</i></button>
        <button class="tb" onclick="exec('underline')" title="Underline (Ctrl+U)" id="btn-underline"><u>U</u></button>
        <button class="tb" onclick="exec('strikeThrough')" title="Strikethrough" id="btn-strikeThrough"><s>S</s></button>
        <button class="tb" onclick="exec('superscript')" title="Superscript"><span style="font-size:10px">X<sup>2</sup></span></button>
        <button class="tb" onclick="exec('subscript')" title="Subscript"><span style="font-size:10px">X<sub>2</sub></span></button>
    </div>

    <!-- Colors -->
    <div class="toolbar-group">
        <button class="tb" title="Text color" style="position:relative;">
            <span style="pointer-events:none;">A</span>
            <div style="width:14px;height:3px;background:red;position:absolute;bottom:4px;pointer-events:none;" id="fgColorBar"></div>
            <input type="color" value="#000000" id="fgColor" onchange="applyFgColor(this.value)" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;">
        </button>
        <button class="tb" title="Highlight color" style="position:relative;">
            <i class="fa-solid fa-highlighter" style="pointer-events:none;font-size:12px;"></i>
            <input type="color" value="#ffff00" id="bgColor" onchange="applyBgColor(this.value)" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;">
        </button>
    </div>

    <!-- Alignment -->
    <div class="toolbar-group">
        <button class="tb" onclick="exec('justifyLeft')" title="Align left"><i class="fa-solid fa-align-left"></i></button>
        <button class="tb" onclick="exec('justifyCenter')" title="Center"><i class="fa-solid fa-align-center"></i></button>
        <button class="tb" onclick="exec('justifyRight')" title="Align right"><i class="fa-solid fa-align-right"></i></button>
        <button class="tb" onclick="exec('justifyFull')" title="Justify"><i class="fa-solid fa-align-justify"></i></button>
    </div>

    <!-- Line Spacing -->
    <div class="toolbar-group">
        <select onchange="applyLineSpacing(this.value)" title="Line spacing" style="width:55px;height:28px;border:1px solid #ccc;border-radius:4px;font-size:11px;">
            <option value="1">1.0</option>
            <option value="1.15">1.15</option>
            <option value="1.5" selected>1.5</option>
            <option value="2">2.0</option>
            <option value="2.5">2.5</option>
            <option value="3">3.0</option>
        </select>
    </div>

    <!-- Lists & Indent -->
    <div class="toolbar-group">
        <button class="tb" onclick="exec('insertUnorderedList')" title="Bullet list"><i class="fa-solid fa-list-ul"></i></button>
        <button class="tb" onclick="exec('insertOrderedList')" title="Numbered list"><i class="fa-solid fa-list-ol"></i></button>
        <button class="tb" onclick="exec('indent')" title="Increase indent"><i class="fa-solid fa-indent"></i></button>
        <button class="tb" onclick="exec('outdent')" title="Decrease indent"><i class="fa-solid fa-outdent"></i></button>
    </div>

    <!-- Insert -->
    <div class="toolbar-group">
        <button class="tb" onclick="insertLink()" title="Insert link"><i class="fa-solid fa-link"></i></button>
        <button class="tb" onclick="insertImage()" title="Insert image"><i class="fa-solid fa-image"></i></button>
        <button class="tb" onclick="insertTable()" title="Insert table"><i class="fa-solid fa-table"></i></button>
        <button class="tb" onclick="insertHR()" title="Horizontal rule"><i class="fa-solid fa-minus"></i></button>
    </div>

    <!-- Clear format -->
    <div class="toolbar-group">
        <button class="tb" onclick="clearFormatting()" title="Clear formatting"><i class="fa-solid fa-eraser"></i></button>
    </div>
</div>

<!-- Ruler -->
<div class="ruler-container" id="rulerContainer"></div>

<!-- Editor -->
<div class="editor-wrapper" id="editorWrapper">
    <div class="page-container" id="editor" contenteditable="true" spellcheck="true"></div>
</div>

<!-- Status Bar -->
<div class="status-bar">
    <div>
        <span id="wordCount">Words: 0</span> &nbsp;|&nbsp; <span id="charCount">Characters: 0</span> &nbsp;|&nbsp; <span id="lineCount">Lines: 0</span>
    </div>
    <div class="zoom-controls">
        <button onclick="zoomOut()"><i class="fa-solid fa-minus"></i></button>
        <input type="range" min="50" max="200" value="100" id="zoomRange" oninput="setZoom(this.value)">
        <button onclick="zoomIn()"><i class="fa-solid fa-plus"></i></button>
        <span id="zoomLabel">100%</span>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Hidden file input -->
<input type="file" id="fileInput" accept=".txt,.html,.htm,.doc,.rtf" style="display:none" onchange="handleOpenFile(event)">
<input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleImageFile(event)">

<script>
// ─── State ───
const editor = document.getElementById('editor');
const CACHE_KEY = 'dimtools_texteditor_cache';
const TITLE_KEY = 'dimtools_texteditor_title';
let saveTimer = null;
let isDark = false;

// ─── Init ───
(function init() {
    // Restore from cache
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) {
        editor.innerHTML = cached;
    }
    const cachedTitle = localStorage.getItem(TITLE_KEY);
    if (cachedTitle) {
        document.getElementById('docTitle').value = cachedTitle;
    }
    buildRuler();
    updateStats();
})();

// ─── Auto-save ───
editor.addEventListener('input', () => {
    scheduleSave();
    updateStats();
    updateActiveButtons();
});
editor.addEventListener('keyup', updateActiveButtons);
editor.addEventListener('mouseup', updateActiveButtons);
document.getElementById('docTitle').addEventListener('input', () => {
    localStorage.setItem(TITLE_KEY, document.getElementById('docTitle').value);
});

function scheduleSave() {
    document.getElementById('saveIndicator').textContent = 'Saving...';
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
        localStorage.setItem(CACHE_KEY, editor.innerHTML);
        document.getElementById('saveIndicator').textContent = 'All changes saved';
    }, 800);
}

function manualSave() {
    localStorage.setItem(CACHE_KEY, editor.innerHTML);
    localStorage.setItem(TITLE_KEY, document.getElementById('docTitle').value);
    document.getElementById('saveIndicator').textContent = 'All changes saved';
    toast('Document saved to browser cache');
    closeAllMenus();
}

// ─── Exec command helper ───
function exec(cmd, value) {
    document.execCommand(cmd, false, value || null);
    editor.focus();
    updateActiveButtons();
    scheduleSave();
}

function updateActiveButtons() {
    ['bold', 'italic', 'underline', 'strikeThrough'].forEach(cmd => {
        const btn = document.getElementById('btn-' + cmd);
        if (btn) {
            btn.classList.toggle('active', document.queryCommandState(cmd));
        }
    });
}

// ─── Heading ───
function applyHeading(val) {
    if (val) {
        exec('formatBlock', 'h' + val);
    } else {
        exec('formatBlock', 'p');
    }
    document.getElementById('headingSelect').value = val;
}

// ─── Font ───
function applyFont(val) { exec('fontName', val); }
function applyFontSize(val) { exec('fontSize', val); }

// ─── Colors ───
function applyFgColor(val) {
    exec('foreColor', val);
    document.getElementById('fgColorBar').style.background = val;
}
function applyBgColor(val) { exec('hiliteColor', val); }

// ─── Line spacing ───
function applyLineSpacing(val) {
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    // wrap in div with line-height
    const range = sel.getRangeAt(0);
    let container = range.commonAncestorContainer;
    if (container.nodeType === 3) container = container.parentElement;
    // find block parent
    while (container && container !== editor && !['P','DIV','H1','H2','H3','H4','H5','H6','LI','BLOCKQUOTE'].includes(container.tagName)) {
        container = container.parentElement;
    }
    if (container && container !== editor) {
        container.style.lineHeight = val;
    } else {
        editor.style.lineHeight = val;
    }
    scheduleSave();
}

// ─── Clear formatting ───
function clearFormatting() {
    exec('removeFormat');
    exec('formatBlock', 'p');
    closeAllMenus();
}

// ─── Insert functions ───
function insertLink() {
    closeAllMenus();
    const url = prompt('Enter URL:', 'https://');
    if (url) exec('createLink', url);
}

function insertImage() {
    closeAllMenus();
    document.getElementById('imageInput').click();
}
function handleImageFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        exec('insertImage', ev.target.result);
    };
    reader.readAsDataURL(file);
    e.target.value = '';
}

function insertHR() {
    closeAllMenus();
    exec('insertHorizontalRule');
}

function insertTable() {
    closeAllMenus();
    const rows = prompt('Number of rows:', '3');
    const cols = prompt('Number of columns:', '3');
    if (!rows || !cols) return;
    let html = '<table>';
    for (let r = 0; r < parseInt(rows); r++) {
        html += '<tr>';
        for (let c = 0; c < parseInt(cols); c++) {
            html += r === 0 ? '<th>&nbsp;</th>' : '<td>&nbsp;</td>';
        }
        html += '</tr>';
    }
    html += '</table><p><br></p>';
    exec('insertHTML', html);
}

function insertDate() {
    closeAllMenus();
    const d = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    exec('insertText', d);
}

function insertSpecialChar() {
    closeAllMenus();
    const chars = '© ® ™ € £ ¥ ° ± × ÷ ≠ ≤ ≥ ∞ √ π Ω α β γ δ ε ← → ↑ ↓ ♠ ♣ ♥ ♦ ★ ☆ ✓ ✗ • — – … « » ¶ § † ‡';
    const ch = prompt('Pick a character:\n\n' + chars);
    if (ch) exec('insertText', ch.trim());
}

function insertPageBreak() {
    closeAllMenus();
    exec('insertHTML', '<div style="page-break-after: always; border-bottom: 2px dashed #ccc; margin: 16px 0; padding: 0;"></div><p><br></p>');
}

// ─── File operations ───
function newDocument() {
    closeAllMenus();
    if (editor.textContent.trim() && !confirm('Create a new document? Unsaved changes will be lost.')) return;
    editor.innerHTML = '';
    document.getElementById('docTitle').value = 'Untitled Document';
    localStorage.removeItem(CACHE_KEY);
    localStorage.removeItem(TITLE_KEY);
    updateStats();
    toast('New document created');
}

function openFile() {
    closeAllMenus();
    document.getElementById('fileInput').click();
}
function handleOpenFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        const content = ev.target.result;
        if (file.name.endsWith('.html') || file.name.endsWith('.htm')) {
            editor.innerHTML = content;
        } else {
            editor.innerText = content;
        }
        document.getElementById('docTitle').value = file.name.replace(/\.[^.]+$/, '');
        scheduleSave();
        updateStats();
        toast('File opened: ' + file.name);
    };
    reader.readAsText(file);
    e.target.value = '';
}

// ─── Download ───
function getDocTitle() {
    return document.getElementById('docTitle').value || 'Untitled Document';
}

function downloadAs(format) {
    closeAllMenus();
    const title = getDocTitle();
    const htmlContent = editor.innerHTML;
    const textContent = editor.innerText;

    switch (format) {
        case 'pdf': downloadPDF(title); break;
        case 'txt': downloadBlob(textContent, title + '.txt', 'text/plain'); break;
        case 'doc': downloadBlob(getWordHtml(htmlContent, title), title + '.doc', 'application/msword'); break;
        case 'docx': downloadDOCX(htmlContent, title); break;
        case 'rtf': downloadBlob(htmlToRtf(textContent), title + '.rtf', 'application/rtf'); break;
        case 'html': downloadBlob(getFullHtml(htmlContent, title), title + '.html', 'text/html'); break;
    }
}

function downloadBlob(content, filename, mime) {
    const blob = new Blob([content], { type: mime + ';charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
    toast('Downloaded: ' + filename);
}

function downloadPDF(title) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'letter' });
    const marginLeft = parseFloat(document.getElementById('marginLeft').value) * 72;
    const marginTop = parseFloat(document.getElementById('marginTop').value) * 72;
    const pageWidth = doc.internal.pageSize.getWidth() - marginLeft * 2;

    const text = editor.innerText;
    const lines = doc.splitTextToSize(text, pageWidth);
    const lineHeight = 14;
    let y = marginTop;
    const pageHeight = doc.internal.pageSize.getHeight() - marginTop * 2;

    doc.setFont('helvetica');
    doc.setFontSize(11);

    lines.forEach(line => {
        if (y + lineHeight > pageHeight + marginTop) {
            doc.addPage();
            y = marginTop;
        }
        doc.text(line, marginLeft, y);
        y += lineHeight;
    });

    doc.save(title + '.pdf');
    toast('Downloaded: ' + title + '.pdf');
}

function downloadDOCX(html, title) {
    try {
        const fullHtml = getWordHtml(html, title);
        const converted = window.htmlDocx.asBlob(fullHtml);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(converted);
        a.download = title + '.docx';
        a.click();
        URL.revokeObjectURL(a.href);
        toast('Downloaded: ' + title + '.docx');
    } catch (e) {
        // Fallback to doc format
        downloadBlob(getWordHtml(html, title), title + '.docx', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
    }
}

function getWordHtml(html, title) {
    return `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${title}</title></head><body>${html}</body></html>`;
}

function getFullHtml(html, title) {
    return `<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${title}</title>
<style>body{font-family:Arial,sans-serif;max-width:800px;margin:40px auto;padding:0 20px;line-height:1.5;color:#333;}
table{border-collapse:collapse;width:100%;}td,th{border:1px solid #ccc;padding:6px 8px;}</style>
</head><body>${html}</body></html>`;
}

function htmlToRtf(text) {
    // Simple RTF encoding
    let rtf = '{\\rtf1\\ansi\\deff0 {\\fonttbl{\\f0 Arial;}}\\f0\\fs22 ';
    const lines = text.split('\n');
    lines.forEach((line, i) => {
        // Escape special RTF chars
        line = line.replace(/\\/g, '\\\\').replace(/\{/g, '\\{').replace(/\}/g, '\\}');
        rtf += line;
        if (i < lines.length - 1) rtf += '\\par ';
    });
    rtf += '}';
    return rtf;
}

// ─── Print ───
function printDoc() {
    closeAllMenus();
    const w = window.open('', '_blank');
    w.document.write(getFullHtml(editor.innerHTML, getDocTitle()));
    w.document.close();
    w.focus();
    w.print();
    w.close();
}

// ─── Find & Replace ───
function toggleFindBar() {
    closeAllMenus();
    const bar = document.getElementById('findBar');
    bar.classList.toggle('show');
    if (bar.classList.contains('show')) document.getElementById('findInput').focus();
}

function findText() {
    const term = document.getElementById('findInput').value;
    if (!term) return;
    window.find(term, false, false, true);
}

function replaceText() {
    const term = document.getElementById('findInput').value;
    const repl = document.getElementById('replaceInput').value;
    if (!term) return;
    if (window.find(term)) {
        document.execCommand('insertText', false, repl);
        scheduleSave();
    }
}

function replaceAllText() {
    const term = document.getElementById('findInput').value;
    const repl = document.getElementById('replaceInput').value;
    if (!term) return;
    let count = 0;
    while (window.find(term, false, false, false)) {
        document.execCommand('insertText', false, repl);
        count++;
        if (count > 5000) break; // safety
    }
    if (count) {
        scheduleSave();
        toast('Replaced ' + count + ' occurrences');
    } else {
        toast('No matches found');
    }
}

function setPageBg() {
    closeAllMenus();
    const colorInput = document.createElement('input');
    colorInput.type = 'color';
    colorInput.value = '#ffffff';
    colorInput.addEventListener('input', (e) => {
        editor.style.backgroundColor = e.target.value;
        scheduleSave();
    });
    colorInput.click();
}

// ─── Spellcheck ───
function toggleSpellCheck() {
    closeAllMenus();
    const current = editor.spellcheck;
    editor.spellcheck = !current;
    editor.focus();
    toast('Spellcheck ' + (!current ? 'enabled' : 'disabled'));
}

// ─── Ruler ───
function buildRuler() {
    const ruler = document.getElementById('rulerContainer');
    let html = '<div class="ruler">';
    for (let i = 0; i <= 8; i++) {
        const px = i * 96; // 1 inch = 96px
        html += `<div class="ruler-tick" style="left:${px}px; height:${i % 1 === 0 ? 10 : 5}px;"></div>`;
        html += `<div class="ruler-label" style="left:${px}px;">${i}</div>`;
        // Half-inch tick
        if (i < 8) {
            html += `<div class="ruler-tick" style="left:${px + 48}px; height:6px;"></div>`;
        }
    }
    html += '</div>';
    ruler.innerHTML = html;
}
function toggleRuler() {
    closeAllMenus();
    const r = document.getElementById('rulerContainer');
    r.style.display = r.style.display === 'none' ? '' : 'none';
}

// ─── Zoom ───
let currentZoom = 100;
function setZoom(val) {
    currentZoom = parseInt(val);
    editor.style.transform = `scale(${currentZoom / 100})`;
    editor.style.transformOrigin = 'top center';
    document.getElementById('zoomRange').value = currentZoom;
    document.getElementById('zoomLabel').textContent = currentZoom + '%';
}
function zoomIn() { setZoom(Math.min(200, currentZoom + 10)); }
function zoomOut() { setZoom(Math.max(50, currentZoom - 10)); }

// ─── Dark Mode ───
function toggleDarkMode() {
    closeAllMenus();
    isDark = !isDark;
    if (isDark) {
        document.body.style.background = '#1e1e1e';
        document.querySelector('.menu-bar').style.background = '#2d2d2d';
        document.querySelector('.menu-bar').style.borderColor = '#444';
        document.querySelector('.toolbar').style.background = '#2d2d2d';
        document.querySelector('.toolbar').style.borderColor = '#444';
        document.querySelector('.status-bar').style.background = '#2d2d2d';
        document.querySelector('.status-bar').style.borderColor = '#444';
        document.querySelector('.status-bar').style.color = '#aaa';
        document.getElementById('editorWrapper').style.background = '#333';
        document.querySelector('.doc-title-input').style.color = '#eee';
        document.querySelector('.save-indicator').style.color = '#888';
        document.querySelectorAll('.top-menu-btn').forEach(b => b.style.color = '#ccc');
        document.querySelectorAll('.tb').forEach(b => b.style.color = '#ccc');
    } else {
        document.body.style.background = '';
        document.body.style.backgroundImage = '';
        document.querySelector('.menu-bar').style.background = '';
        document.querySelector('.menu-bar').style.borderColor = '';
        document.querySelector('.toolbar').style.background = '';
        document.querySelector('.toolbar').style.borderColor = '';
        document.querySelector('.status-bar').style.background = '';
        document.querySelector('.status-bar').style.borderColor = '';
        document.querySelector('.status-bar').style.color = '';
        document.getElementById('editorWrapper').style.background = '';
        document.querySelector('.doc-title-input').style.color = '';
        document.querySelector('.save-indicator').style.color = '';
        document.querySelectorAll('.top-menu-btn').forEach(b => b.style.color = '');
        document.querySelectorAll('.tb').forEach(b => b.style.color = '');
    }
}

// ─── Fullscreen ───
function toggleFullscreen() {
    closeAllMenus();
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

// ─── Word / Char count ───
function updateStats() {
    const text = editor.innerText || '';
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    const chars = text.length;
    const lines = text.split('\n').length;
    document.getElementById('wordCount').textContent = 'Words: ' + words;
    document.getElementById('charCount').textContent = 'Characters: ' + chars;
    document.getElementById('lineCount').textContent = 'Lines: ' + lines;
}

// ─── Dropdown menus ───
document.querySelectorAll('.top-menu-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const menuId = 'menu-' + btn.dataset.menu;
        const menu = document.getElementById(menuId);
        const isOpen = menu.classList.contains('show');
        closeAllMenus();
        if (!isOpen) menu.classList.add('show');
    });
});
function closeAllMenus() {
    document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
}
document.addEventListener('click', (e) => {
    if (!e.target.closest('.dropdown-menu') && !e.target.closest('.top-menu-btn')) {
        closeAllMenus();
    }
});

// ─── Keyboard shortcuts ───
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        manualSave();
    }
    if (e.ctrlKey && e.key === 'h') {
        e.preventDefault();
        toggleFindBar();
    }
    if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        insertLink();
    }
    if (e.ctrlKey && e.altKey && e.key === 'n') {
        e.preventDefault();
        newDocument();
    }
    if (e.ctrlKey && e.key === 'o') {
        e.preventDefault();
        openFile();
    }
});

// ─── Toast ───
function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

// ─── Paste handler (clean paste) ───
editor.addEventListener('paste', (e) => {
    // Allow rich paste by default; clean paste with Ctrl+Shift+V is handled by browser
});

// ─── Drag & Drop images ───
editor.addEventListener('dragover', (e) => e.preventDefault());
editor.addEventListener('drop', (e) => {
    e.preventDefault();
    const files = e.dataTransfer.files;
    if (files.length && files[0].type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            exec('insertImage', ev.target.result);
        };
        reader.readAsDataURL(files[0]);
    }
});

// ─── Tab key support ───
editor.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
        e.preventDefault();
        exec('insertHTML', '&emsp;&emsp;');
    }
});

// ─── Save on beforeunload ───
window.addEventListener('beforeunload', () => {
    localStorage.setItem(CACHE_KEY, editor.innerHTML);
    localStorage.setItem(TITLE_KEY, document.getElementById('docTitle').value);
});
</script>
</body>
</html>
