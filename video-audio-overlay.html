<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DimTools - Video Audio Overlay Editor</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0d0d0d;
            color: #fff;
        }

        /* Main App Layout */
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* Top Header Bar */
        .header {
            height: 48px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #2a2a2a;
            color: #ccc;
            border: 1px solid #444;
        }

        .btn-secondary:hover {
            background: #333;
            color: #fff;
        }

        /* Main Workspace */
        .workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }

        /* Left Sidebar - Media Library */
        .sidebar-left {
            width: 240px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #333;
        }

        .upload-buttons {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .upload-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #252525;
            border: 1px dashed #444;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: #aaa;
            font-size: 13px;
        }

        .upload-btn:hover {
            background: #2a2a2a;
            border-color: #ff6b6b;
            color: #fff;
        }

        .upload-btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .upload-btn-icon.video {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .upload-btn-icon.audio {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
        }

        .media-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .media-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: #252525;
            border-radius: 4px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .media-item:hover {
            background: #2f2f2f;
        }

        .media-icon {
            width: 36px;
            height: 28px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .media-icon.video { background: rgba(255, 107, 107, 0.3); color: #ff6b6b; }
        .media-icon.audio { background: rgba(78, 205, 196, 0.3); color: #4ecdc4; }

        .media-info {
            flex: 1;
            min-width: 0;
        }

        .media-name {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #ddd;
        }

        .media-duration {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }

        .media-remove {
            opacity: 0;
            background: none;
            border: none;
            color: #ff4757;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .media-item:hover .media-remove {
            opacity: 1;
        }

        /* Center - Preview Area */
        .preview-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0d0d0d;
            min-width: 0;
        }

        .preview-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            min-height: 0;
        }

        .video-container {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            background: #000;
            border-radius: 4px;
            overflow: hidden;
        }

        #videoPreview {
            display: block;
            max-width: 100%;
            max-height: calc(100vh - 350px);
            background: #000;
        }

        .preview-empty {
            text-align: center;
            color: #555;
        }

        .preview-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .preview-empty h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #666;
        }

        .preview-empty p {
            font-size: 13px;
        }

        /* Playback Controls */
        .playback-bar {
            background: #1a1a1a;
            padding: 12px 16px;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .transport-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .transport-btn {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            background: #2a2a2a;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .transport-btn:hover {
            background: #333;
            color: #fff;
        }

        .play-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .play-btn:hover {
            transform: scale(1.05);
        }

        .time-display {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 13px;
            color: #888;
            min-width: 140px;
            text-align: center;
        }

        .time-current {
            color: #fff;
        }

        /* Right Sidebar - Properties */
        .sidebar-right {
            width: 260px;
            background: #1a1a1a;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .property-section {
            padding: 16px;
            border-bottom: 1px solid #333;
        }

        .property-title {
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .property-title-icon {
            font-size: 14px;
        }

        .property-row {
            margin-bottom: 12px;
        }

        .property-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
            display: block;
        }

        .property-slider {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            background: #333;
            border-radius: 2px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb:hover {
            background: #ff6b6b;
        }

        .property-value {
            font-size: 12px;
            color: #aaa;
            min-width: 45px;
            text-align: right;
        }

        .property-input {
            width: 100%;
            padding: 8px 10px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
        }

        .property-input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .property-select {
            width: 100%;
            padding: 8px 10px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
        }

        /* Timeline */
        .timeline {
            height: 200px;
            background: #141414;
            border-top: 1px solid #333;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .timeline-toolbar {
            height: 36px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
        }

        .timeline-title {
            font-size: 12px;
            font-weight: 500;
            color: #888;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-btn {
            width: 24px;
            height: 24px;
            background: #2a2a2a;
            border: none;
            border-radius: 3px;
            color: #888;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: #333;
            color: #fff;
        }

        .zoom-level {
            font-size: 11px;
            color: #666;
            min-width: 40px;
            text-align: center;
        }

        .timeline-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .track-labels {
            width: 80px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            flex-shrink: 0;
        }

        .track-label {
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 6px;
            font-size: 11px;
            color: #888;
            border-bottom: 1px solid #282828;
        }

        .track-label-icon {
            font-size: 12px;
        }

        .track-label-icon.video { color: #ff6b6b; }
        .track-label-icon.audio { color: #4ecdc4; }

        .timeline-scroll {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            position: relative;
        }

        .timeline-inner {
            position: relative;
            min-width: 100%;
            height: 100%;
        }

        /* Time Ruler */
        .time-ruler {
            height: 24px;
            background: #1e1e1e;
            border-bottom: 1px solid #333;
            position: relative;
        }

        .ruler-mark {
            position: absolute;
            top: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .ruler-mark-line {
            width: 1px;
            background: #444;
        }

        .ruler-mark-line.major {
            height: 12px;
        }

        .ruler-mark-line.minor {
            height: 6px;
        }

        .ruler-mark-label {
            font-size: 9px;
            color: #666;
            margin-top: 2px;
        }

        /* Tracks */
        .tracks-container {
            position: relative;
        }

        .track {
            height: 50px;
            position: relative;
            border-bottom: 1px solid #282828;
        }

        .track-video {
            background: rgba(255, 107, 107, 0.05);
        }

        .track-audio {
            background: rgba(78, 205, 196, 0.05);
        }

        .track-empty {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            color: #444;
        }

        .clip {
            position: absolute;
            top: 6px;
            height: calc(100% - 12px);
            border-radius: 4px;
            cursor: move;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            color: #fff;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            user-select: none;
        }

        .clip-video {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .clip-audio {
            background: linear-gradient(135deg, #4ecdc4, #26a69a);
        }

        .clip-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: ew-resize;
        }

        .clip-handle:hover {
            background: rgba(255,255,255,0.3);
        }

        .clip-handle-left { left: 0; border-radius: 4px 0 0 4px; }
        .clip-handle-right { right: 0; border-radius: 0 4px 4px 0; }

        /* Playhead */
        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #fff;
            z-index: 50;
            pointer-events: none;
        }

        .playhead::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -5px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #fff;
        }

        /* Hidden inputs */
        .hidden {
            display: none !important;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 24px;
            width: 400px;
            max-width: 90%;
        }

        .modal h2 {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        .progress-bar {
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ee5a24);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 8px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 220px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 13px;
            z-index: 500;
            display: none;
        }

        .toast.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
<script src="nav-box.js"></script>

<div class="app">
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">‚ñ∂</div>
            <span>DimTools Video Editor</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="resetProject()">New</button>
            <button class="btn btn-primary" id="exportBtn" onclick="openExportModal()" disabled>Export</button>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="workspace">
        <!-- Left Sidebar -->
        <aside class="sidebar-left">
            <div class="sidebar-header">Media</div>
            <div class="upload-buttons">
                <div class="upload-btn" onclick="document.getElementById('videoInput').click()">
                    <div class="upload-btn-icon video">‚ñ∂</div>
                    <div>
                        <div style="font-weight: 500; color: #fff;">Add Video</div>
                        <div style="font-size: 11px;">MP4, WebM, MOV</div>
                    </div>
                </div>
                <div class="upload-btn" onclick="document.getElementById('audioInput').click()">
                    <div class="upload-btn-icon audio">‚ô™</div>
                    <div>
                        <div style="font-weight: 500; color: #fff;">Add Audio</div>
                        <div style="font-size: 11px;">MP3, WAV, OGG</div>
                    </div>
                </div>
            </div>
            <input type="file" id="videoInput" class="hidden" accept="video/*">
            <input type="file" id="audioInput" class="hidden" accept="audio/*">
            <div class="media-list" id="mediaList"></div>
        </aside>

        <!-- Preview Area -->
        <main class="preview-area">
            <div class="preview-wrapper">
                <div class="video-container" id="videoContainer" style="display: none;">
                    <video id="videoPreview"></video>
                </div>
                <div class="preview-empty" id="previewEmpty">
                    <div class="preview-empty-icon">üé¨</div>
                    <h3>No Video</h3>
                    <p>Add a video to get started</p>
                </div>
            </div>

            <!-- Playback Controls -->
            <div class="playback-bar">
                <div class="transport-controls">
                    <button class="transport-btn" onclick="skipTime(-5)" title="Back 5s">‚è™</button>
                    <button class="transport-btn" onclick="skipTime(-1/30)" title="Previous frame">‚óÄ</button>
                    <button class="play-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
                    <button class="transport-btn" onclick="skipTime(1/30)" title="Next frame">‚ñ∂</button>
                    <button class="transport-btn" onclick="skipTime(5)" title="Forward 5s">‚è©</button>
                </div>
                <div class="time-display">
                    <span class="time-current" id="currentTime">00:00.00</span>
                    <span> / </span>
                    <span id="totalTime">00:00.00</span>
                </div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="sidebar-right">
            <div class="property-section">
                <div class="property-title">
                    <span class="property-title-icon" style="color: #ff6b6b;">‚ñ∂</span>
                    Video
                </div>
                <div class="property-row">
                    <label class="property-label">Speed</label>
                    <div class="property-slider">
                        <input type="range" class="slider" id="videoSpeed" min="0.25" max="4" step="0.05" value="1" oninput="setVideoSpeed(this.value)">
                        <span class="property-value" id="videoSpeedVal">1.00x</span>
                    </div>
                </div>
                <div class="property-row">
                    <label class="property-label">Volume</label>
                    <div class="property-slider">
                        <input type="range" class="slider" id="videoVolume" min="0" max="1" step="0.01" value="0" oninput="setVideoVolume(this.value)">
                        <span class="property-value" id="videoVolumeVal">0%</span>
                    </div>
                </div>
            </div>

            <div class="property-section">
                <div class="property-title">
                    <span class="property-title-icon" style="color: #4ecdc4;">‚ô™</span>
                    Audio Overlay
                </div>
                <div class="property-row">
                    <label class="property-label">Speed</label>
                    <div class="property-slider">
                        <input type="range" class="slider" id="audioSpeed" min="0.25" max="4" step="0.05" value="1" oninput="setAudioSpeed(this.value)">
                        <span class="property-value" id="audioSpeedVal">1.00x</span>
                    </div>
                </div>
                <div class="property-row">
                    <label class="property-label">Volume</label>
                    <div class="property-slider">
                        <input type="range" class="slider" id="audioVolume" min="0" max="1" step="0.01" value="1" oninput="setAudioVolume(this.value)">
                        <span class="property-value" id="audioVolumeVal">100%</span>
                    </div>
                </div>
                <div class="property-row">
                    <label class="property-label">Offset (seconds)</label>
                    <input type="number" class="property-input" id="audioOffset" value="0" step="0.1" onchange="setAudioOffset(this.value)">
                </div>
            </div>

            <div class="property-section">
                <div class="property-title">Export Settings</div>
                <div class="property-row">
                    <label class="property-label">Format</label>
                    <select class="property-select" id="exportFormat">
                        <option value="mp4">MP4</option>
                        <option value="webm">WebM</option>
                    </select>
                </div>
                <div class="property-row">
                    <label class="property-label">Quality</label>
                    <select class="property-select" id="exportQuality">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
            </div>
        </aside>
    </div>

    <!-- Timeline -->
    <div class="timeline">
        <div class="timeline-toolbar">
            <span class="timeline-title">Timeline</span>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomTimeline(-1)">‚àí</button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="zoom-btn" onclick="zoomTimeline(1)">+</button>
            </div>
        </div>
        <div class="timeline-content">
            <div class="track-labels">
                <div class="track-label" style="height: 24px;"></div>
                <div class="track-label">
                    <span class="track-label-icon video">‚ñ∂</span>
                    Video
                </div>
                <div class="track-label">
                    <span class="track-label-icon audio">‚ô™</span>
                    Audio
                </div>
            </div>
            <div class="timeline-scroll" id="timelineScroll">
                <div class="timeline-inner" id="timelineInner">
                    <div class="time-ruler" id="timeRuler"></div>
                    <div class="tracks-container">
                        <div class="track track-video" id="videoTrack">
                            <span class="track-empty" id="videoTrackEmpty">Drop video here</span>
                        </div>
                        <div class="track track-audio" id="audioTrack">
                            <span class="track-empty" id="audioTrackEmpty">Drop audio here</span>
                        </div>
                    </div>
                    <div class="playhead" id="playhead"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal-overlay" id="exportModal">
    <div class="modal">
        <h2>Export Video</h2>
        <div class="property-row">
            <label class="property-label">Filename</label>
            <input type="text" class="property-input" id="exportFilename" value="my-video">
        </div>
        <div class="progress-bar" id="exportProgress" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <p class="progress-text" id="progressText" style="display: none;">Preparing...</p>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
            <button class="btn btn-primary" id="startExportBtn" onclick="startExport()">Export</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Hidden Audio -->
<audio id="audioPlayer"></audio>

<script>
    // State
    let videoFile = null;
    let audioFile = null;
    let isPlaying = false;
    let audioOffset = 0;
    let zoom = 1;
    let pixelsPerSecond = 50;
    let ffmpeg = null;
    let ffmpegLoaded = false;

    // Elements
    const video = document.getElementById('videoPreview');
    const audio = document.getElementById('audioPlayer');
    const playBtn = document.getElementById('playBtn');
    const playhead = document.getElementById('playhead');
    const timeRuler = document.getElementById('timeRuler');
    const timelineInner = document.getElementById('timelineInner');
    const timelineScroll = document.getElementById('timelineScroll');

    // Initialize
    document.getElementById('videoInput').addEventListener('change', e => {
        if (e.target.files[0]) loadVideo(e.target.files[0]);
    });

    document.getElementById('audioInput').addEventListener('change', e => {
        if (e.target.files[0]) loadAudio(e.target.files[0]);
    });

    video.addEventListener('timeupdate', updatePlayhead);
    video.addEventListener('loadedmetadata', onVideoLoad);
    video.addEventListener('ended', () => { isPlaying = false; playBtn.textContent = '‚ñ∂'; });

    // Load video
    function loadVideo(file) {
        videoFile = file;
        video.src = URL.createObjectURL(file);
        document.getElementById('videoContainer').style.display = 'block';
        document.getElementById('previewEmpty').style.display = 'none';
        updateMediaList();
        toast('Video loaded', 'success');
    }

    // Load audio
    function loadAudio(file) {
        audioFile = file;
        audio.src = URL.createObjectURL(file);
        audio.addEventListener('loadedmetadata', () => {
            updateAudioClip();
            updateMediaList();
        }, { once: true });
        toast('Audio loaded', 'success');
    }

    // On video loaded
    function onVideoLoad() {
        document.getElementById('totalTime').textContent = formatTime(video.duration);
        document.getElementById('exportBtn').disabled = false;
        updateVideoClip();
        drawRuler();
    }

    // Update media list
    function updateMediaList() {
        const list = document.getElementById('mediaList');
        list.innerHTML = '';

        if (videoFile) {
            list.innerHTML += `
                <div class="media-item">
                    <div class="media-icon video">‚ñ∂</div>
                    <div class="media-info">
                        <div class="media-name">${videoFile.name}</div>
                        <div class="media-duration">${formatFileSize(videoFile.size)}</div>
                    </div>
                    <button class="media-remove" onclick="removeVideo()">√ó</button>
                </div>`;
        }

        if (audioFile) {
            list.innerHTML += `
                <div class="media-item">
                    <div class="media-icon audio">‚ô™</div>
                    <div class="media-info">
                        <div class="media-name">${audioFile.name}</div>
                        <div class="media-duration">${formatFileSize(audioFile.size)}</div>
                    </div>
                    <button class="media-remove" onclick="removeAudio()">√ó</button>
                </div>`;
        }
    }

    // Remove video
    function removeVideo() {
        videoFile = null;
        video.src = '';
        document.getElementById('videoContainer').style.display = 'none';
        document.getElementById('previewEmpty').style.display = 'block';
        document.getElementById('videoTrack').innerHTML = '<span class="track-empty">Drop video here</span>';
        document.getElementById('exportBtn').disabled = true;
        updateMediaList();
        drawRuler();
    }

    // Remove audio
    function removeAudio() {
        audioFile = null;
        audio.src = '';
        document.getElementById('audioTrack').innerHTML = '<span class="track-empty">Drop audio here</span>';
        updateMediaList();
    }

    // Play/Pause
    function togglePlay() {
        if (!videoFile) return toast('Add a video first', 'error');

        if (isPlaying) {
            video.pause();
            audio.pause();
            playBtn.textContent = '‚ñ∂';
        } else {
            video.play();
            syncAudio();
            playBtn.textContent = '‚è∏';
        }
        isPlaying = !isPlaying;
    }

    // Sync audio with video
    function syncAudio() {
        if (!audioFile) return;

        const audioTime = video.currentTime - audioOffset;
        if (audioTime >= 0 && audioTime < audio.duration) {
            audio.currentTime = audioTime;
            audio.play();
        } else if (audioTime < 0) {
            audio.pause();
            setTimeout(() => {
                if (isPlaying) {
                    audio.currentTime = 0;
                    audio.play();
                }
            }, Math.abs(audioTime) * 1000);
        }
    }

    // Skip time
    function skipTime(delta) {
        if (!videoFile) return;
        video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + delta));
        updatePlayhead();
        if (isPlaying) syncAudio();
    }

    // Update playhead
    function updatePlayhead() {
        const time = video.currentTime || 0;
        document.getElementById('currentTime').textContent = formatTime(time);
        playhead.style.left = (time * pixelsPerSecond * zoom) + 'px';

        // Keep audio synced
        if (isPlaying && audioFile) {
            const expectedAudioTime = time - audioOffset;
            if (expectedAudioTime >= 0 && expectedAudioTime < audio.duration) {
                if (Math.abs(audio.currentTime - expectedAudioTime) > 0.3) {
                    audio.currentTime = expectedAudioTime;
                }
                if (audio.paused) audio.play();
            }
        }
    }

    // Speed/Volume controls
    function setVideoSpeed(val) {
        video.playbackRate = parseFloat(val);
        document.getElementById('videoSpeedVal').textContent = parseFloat(val).toFixed(2) + 'x';
    }

    function setVideoVolume(val) {
        video.volume = parseFloat(val);
        video.muted = val == 0;
        document.getElementById('videoVolumeVal').textContent = Math.round(val * 100) + '%';
    }

    function setAudioSpeed(val) {
        audio.playbackRate = parseFloat(val);
        document.getElementById('audioSpeedVal').textContent = parseFloat(val).toFixed(2) + 'x';
    }

    function setAudioVolume(val) {
        audio.volume = parseFloat(val);
        document.getElementById('audioVolumeVal').textContent = Math.round(val * 100) + '%';
    }

    function setAudioOffset(val) {
        audioOffset = parseFloat(val) || 0;
        updateAudioClip();
    }

    // Timeline clips
    function updateVideoClip() {
        const track = document.getElementById('videoTrack');
        const duration = video.duration || 0;
        const width = duration * pixelsPerSecond * zoom;

        track.innerHTML = `<div class="clip clip-video" style="left: 0; width: ${width}px;">${videoFile?.name || 'Video'}</div>`;
        updateTimelineWidth();
    }

    function updateAudioClip() {
        const track = document.getElementById('audioTrack');
        const duration = audio.duration || 0;
        const width = duration * pixelsPerSecond * zoom;
        const left = Math.max(0, audioOffset * pixelsPerSecond * zoom);

        track.innerHTML = `<div class="clip clip-audio" style="left: ${left}px; width: ${width}px;"
            onmousedown="startDragClip(event, 'audio')">${audioFile?.name || 'Audio'}</div>`;
        updateTimelineWidth();
    }

    function updateTimelineWidth() {
        const videoDur = video.duration || 0;
        const audioDur = (audio.duration || 0) + Math.max(0, audioOffset);
        const maxDur = Math.max(videoDur, audioDur, 30);
        timelineInner.style.width = (maxDur * pixelsPerSecond * zoom + 100) + 'px';
    }

    // Drag audio clip
    let dragClip = null;
    let dragStartX = 0;
    let dragStartOffset = 0;

    function startDragClip(e, type) {
        if (type !== 'audio') return;
        dragClip = e.target;
        dragStartX = e.clientX;
        dragStartOffset = audioOffset;
        document.addEventListener('mousemove', dragClipMove);
        document.addEventListener('mouseup', dragClipEnd);
    }

    function dragClipMove(e) {
        if (!dragClip) return;
        const dx = e.clientX - dragStartX;
        const newOffset = Math.max(0, dragStartOffset + dx / (pixelsPerSecond * zoom));
        audioOffset = newOffset;
        document.getElementById('audioOffset').value = newOffset.toFixed(2);
        dragClip.style.left = (newOffset * pixelsPerSecond * zoom) + 'px';
    }

    function dragClipEnd() {
        dragClip = null;
        document.removeEventListener('mousemove', dragClipMove);
        document.removeEventListener('mouseup', dragClipEnd);
    }

    // Draw time ruler
    function drawRuler() {
        const duration = Math.max(video.duration || 30, (audio.duration || 0) + audioOffset, 30);
        let html = '';

        let interval = 1;
        if (zoom < 0.5) interval = 5;
        if (zoom < 0.25) interval = 10;
        if (zoom > 2) interval = 0.5;

        for (let t = 0; t <= duration; t += interval) {
            const x = t * pixelsPerSecond * zoom;
            const isMajor = t % (interval * 5 === 0 ? interval : interval * 2) === 0 || interval >= 5;

            html += `<div class="ruler-mark" style="left: ${x}px;">
                <div class="ruler-mark-line ${isMajor ? 'major' : 'minor'}"></div>
                ${isMajor ? `<span class="ruler-mark-label">${formatTimeShort(t)}</span>` : ''}
            </div>`;
        }

        timeRuler.innerHTML = html;
    }

    // Click ruler to seek
    timelineScroll.addEventListener('click', (e) => {
        if (!videoFile || e.target.closest('.clip')) return;
        const rect = timelineScroll.getBoundingClientRect();
        const x = e.clientX - rect.left + timelineScroll.scrollLeft;
        const time = x / (pixelsPerSecond * zoom);
        video.currentTime = Math.max(0, Math.min(video.duration, time));
        updatePlayhead();
    });

    // Zoom
    function zoomTimeline(dir) {
        if (dir > 0) zoom = Math.min(4, zoom * 1.25);
        else zoom = Math.max(0.25, zoom / 1.25);

        document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';

        if (videoFile) updateVideoClip();
        if (audioFile) updateAudioClip();
        drawRuler();
        updatePlayhead();
    }

    // Export
    function openExportModal() {
        document.getElementById('exportModal').classList.add('active');
    }

    function closeExportModal() {
        document.getElementById('exportModal').classList.remove('active');
        document.getElementById('exportProgress').style.display = 'none';
        document.getElementById('progressText').style.display = 'none';
    }

    async function startExport() {
        const filename = document.getElementById('exportFilename').value || 'video';
        const format = document.getElementById('exportFormat').value;

        document.getElementById('exportProgress').style.display = 'block';
        document.getElementById('progressText').style.display = 'block';
        document.getElementById('progressText').textContent = 'Loading FFmpeg...';
        document.getElementById('startExportBtn').disabled = true;

        try {
            if (!ffmpegLoaded) {
                const { FFmpeg } = FFmpegWASM;
                const { fetchFile, toBlobURL } = FFmpegUtil;

                ffmpeg = new FFmpeg();
                ffmpeg.on('progress', ({ progress }) => {
                    const pct = Math.round(progress * 100);
                    document.getElementById('progressFill').style.width = pct + '%';
                    document.getElementById('progressText').textContent = `Processing: ${pct}%`;
                });

                const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/esm';
                await ffmpeg.load({
                    coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                    wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
                });
                ffmpegLoaded = true;
            }

            const { fetchFile } = FFmpegUtil;
            document.getElementById('progressText').textContent = 'Preparing files...';

            const videoExt = videoFile.name.split('.').pop();
            await ffmpeg.writeFile(`input.${videoExt}`, await fetchFile(videoFile));

            let args = ['-i', `input.${videoExt}`];

            if (audioFile) {
                const audioExt = audioFile.name.split('.').pop();
                await ffmpeg.writeFile(`audio.${audioExt}`, await fetchFile(audioFile));

                if (audioOffset >= 0) {
                    args.push('-itsoffset', audioOffset.toString(), '-i', `audio.${audioExt}`);
                } else {
                    args.push('-ss', Math.abs(audioOffset).toString(), '-i', `audio.${audioExt}`);
                }

                const videoVol = parseFloat(document.getElementById('videoVolume').value);
                const audioVol = parseFloat(document.getElementById('audioVolume').value);

                args.push('-filter_complex',
                    `[0:a]volume=${videoVol}[va];[1:a]volume=${audioVol}[aa];[va][aa]amix=inputs=2:duration=longest[a]`);
                args.push('-map', '0:v', '-map', '[a]');
            }

            if (format === 'mp4') {
                args.push('-c:v', 'libx264', '-c:a', 'aac');
            } else {
                args.push('-c:v', 'libvpx-vp9', '-c:a', 'libopus');
            }

            args.push('-y', `output.${format}`);

            document.getElementById('progressText').textContent = 'Encoding...';
            await ffmpeg.exec(args);

            const data = await ffmpeg.readFile(`output.${format}`);
            const blob = new Blob([data.buffer], { type: `video/${format}` });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.${format}`;
            a.click();
            URL.revokeObjectURL(url);

            document.getElementById('progressText').textContent = 'Done!';
            document.getElementById('progressFill').style.width = '100%';
            toast('Export complete!', 'success');

            setTimeout(closeExportModal, 1500);

        } catch (err) {
            console.error(err);
            document.getElementById('progressText').textContent = 'Error: ' + err.message;
            toast('Export failed', 'error');
        }

        document.getElementById('startExportBtn').disabled = false;
    }

    // Reset
    function resetProject() {
        if ((videoFile || audioFile) && !confirm('Start new project?')) return;
        removeVideo();
        removeAudio();
        audioOffset = 0;
        document.getElementById('audioOffset').value = 0;
        zoom = 1;
        document.getElementById('zoomLevel').textContent = '100%';
        drawRuler();
    }

    // Toast
    function toast(msg, type) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast show ' + (type || '');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // Utils
    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        const ms = Math.floor((s % 1) * 100);
        return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
    }

    function formatTimeShort(s) {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return `${m}:${sec.toString().padStart(2, '0')}`;
    }

    function formatFileSize(b) {
        if (b < 1024) return b + ' B';
        if (b < 1024 * 1024) return (b / 1024).toFixed(1) + ' KB';
        return (b / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
        if (e.code === 'ArrowLeft') { e.preventDefault(); skipTime(e.shiftKey ? -5 : -1); }
        if (e.code === 'ArrowRight') { e.preventDefault(); skipTime(e.shiftKey ? 5 : 1); }
    });

    // Init
    drawRuler();
</script>
</body>
</html>
