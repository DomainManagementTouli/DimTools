<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>DimTools - Menu Tally & Noteboard</title>
    <link rel="icon" href="favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        @import url("https://unpkg.com/papercss@1.9.2/dist/paper.css");

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background-color: #e8edf6;
            background-size: 20px 20px;
            background-image: repeating-linear-gradient(0deg, #cfd5e5, #cfd5e5 1px, #e8edf6 1px, #e8edf6);
            min-height: 100vh;
            padding: 20px;
        }

        /* Login styles */
        .login-container {
            max-width: 400px;
            margin: 80px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            padding: 40px;
            border: 2px solid #1a3c8b;
        }
        .login-container h1 {
            font-size: 22px;
            margin-bottom: 8px;
            color: #1a3c8b;
            text-align: center;
        }
        .login-container p {
            color: #6c757d;
            margin-bottom: 24px;
            font-size: 14px;
            text-align: center;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .login-form label {
            font-size: 14px;
            font-weight: 600;
            color: #1a3c8b;
            margin-bottom: 5px;
        }
        .login-form input {
            padding: 10px 12px;
            border: 2px solid #8ba3d9;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        .login-form input:focus {
            outline: none;
            border-color: #1a3c8b;
        }
        .login-form button {
            padding: 12px;
            background: #1a3c8b;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-form button:hover { background: #2952a3; }
        .login-form button:disabled { opacity: 0.6; cursor: not-allowed; }
        .message {
            padding: 10px;
            border-radius: 5px;
            font-size: 13px;
            display: none;
            margin-bottom: 10px;
        }
        .message.show { display: block; }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Main app */
        .app-wrapper {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }
        .app-wrapper.show { display: block; }

        /* Header */
        .app-header {
            background: white;
            border: 2px solid #1a3c8b;
            border-radius: 8px;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
        }
        .app-header h1 {
            font-size: 20px;
            color: #1a3c8b;
            margin: 0;
        }
        .app-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: #666;
        }
        .logout-btn {
            background: #2b5bbd;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .logout-btn:hover { background: #1a3c8b; }

        /* Layout: side menu + content */
        .main-layout {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        /* Side menu */
        .side-menu {
            width: 240px;
            min-width: 240px;
            background: white;
            border: 2px solid #1a3c8b;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
        }
        .side-menu-title {
            background: #1a3c8b;
            color: white;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
        }
        .side-menu-list {
            overflow-y: auto;
            flex: 1;
        }
        .unit-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px 14px;
            border: none;
            background: white;
            font-size: 13px;
            color: #333;
            cursor: pointer;
            text-align: left;
            transition: background 0.15s;
            border-bottom: 1px solid #e8edf6;
            gap: 8px;
        }
        .unit-btn:hover { background: #edf0f9; }
        .unit-btn.active {
            background: #e8edf6;
            font-weight: 600;
            color: #1a3c8b;
            border-left: 3px solid #1a3c8b;
        }
        .unit-btn .has-pdf {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #28a745;
            flex-shrink: 0;
        }
        .unit-btn .no-pdf {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #ccc;
            flex-shrink: 0;
        }
        .unit-btn .btn-label {
            flex: 1;
            line-height: 1.3;
        }

        /* Content area */
        .content-area {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Section card */
        .section-card {
            background: white;
            border-radius: 8px;
            border: 2px solid #1a3c8b;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .section-title {
            background: #1a3c8b;
            color: white;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: 600;
            margin: 0;
        }
        .section-body {
            padding: 20px;
        }

        /* PDF detail header */
        .pdf-detail-header {
            margin-bottom: 14px;
        }
        .pdf-detail-header h2 {
            font-size: 18px;
            color: #1a3c8b;
            margin: 0 0 4px;
        }
        .pdf-detail-header .time-range {
            font-size: 14px;
            color: #666;
        }
        .pdf-detail-header .upload-meta {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        /* Upload area */
        .upload-area {
            border: 2px dashed #1a3c8b;
            border-radius: 5px;
            padding: 1.2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0f3fa;
            margin-bottom: 14px;
        }
        .upload-area:hover {
            background: #dce2f0;
            border-color: #2952a3;
        }
        .upload-area.dragover {
            background: #dce2f0;
            border-style: solid;
        }
        .upload-area h3 {
            margin: 0 0 4px;
            color: #1a3c8b;
            font-size: 14px;
        }
        .upload-area p {
            margin: 0;
            color: #666;
            font-size: 12px;
        }
        .upload-status {
            font-size: 13px;
            color: #666;
            display: none;
            margin-bottom: 10px;
        }
        .upload-status.show { display: block; }
        .upload-status.success { color: #155724; }
        .upload-status.error { color: #721c24; }

        /* No selection state */
        .no-selection {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .no-selection h3 {
            color: #1a3c8b;
            margin-bottom: 8px;
            font-size: 16px;
        }

        /* PDF viewer */
        .pdf-viewer {
            display: none;
        }
        .pdf-viewer.show { display: block; }
        .pdf-pages-container {
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #cfd5e5;
            border-radius: 5px;
            background: #e0e4ee;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .pdf-pages-container canvas {
            max-width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            background: white;
        }

        /* Noteboard */
        .noteboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        .noteboard-item {
            background: #f0f3fa;
            border: 1px solid #8ba3d9;
            border-left: 4px solid #2b5bbd;
            border-radius: 4px;
            padding: 10px 14px;
            font-size: 14px;
            color: #333;
            word-break: break-word;
        }
        .noteboard-item .note-meta {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }
        .noteboard-item .note-delete {
            float: right;
            background: none;
            border: none;
            color: #c0392b;
            cursor: pointer;
            font-size: 14px;
            padding: 0 4px;
            opacity: 0.6;
        }
        .noteboard-item .note-delete:hover { opacity: 1; }
        .noteboard-input-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .noteboard-input-row textarea {
            flex: 1;
            border: 2px solid #8ba3d9;
            border-radius: 5px;
            padding: 10px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 44px;
            max-height: 100px;
            transition: border-color 0.2s;
        }
        .noteboard-input-row textarea:focus {
            outline: none;
            border-color: #1a3c8b;
        }
        .noteboard-input-row button {
            background: #1a3c8b;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .noteboard-input-row button:hover { background: #2952a3; }
        .noteboard-input-row button:disabled { opacity: 0.6; cursor: not-allowed; }
        .char-count {
            font-size: 11px;
            color: #999;
            text-align: right;
            margin-top: 4px;
        }
        .char-count.over { color: #c0392b; }
        .no-notes {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        /* Spinner */
        .spinner-small {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1a3c8b;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            .side-menu {
                width: 100%;
                min-width: 0;
                position: static;
                max-height: 250px;
            }
            .app-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            .app-header-right {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            .logout-btn { width: 100%; text-align: center; }
            .noteboard-input-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<script src="nav-box.js"></script>

<!-- Login Screen -->
<div class="login-container" id="loginContainer">
    <h1>Menu Tally & Noteboard</h1>
    <p>Sign in to access uploads and notes</p>
    <div class="message" id="loginMessage"></div>
    <form class="login-form" id="loginForm">
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="Enter your email" required autocomplete="email">
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter your password" required autocomplete="current-password">
        </div>
        <button type="submit" id="loginBtn">Sign In</button>
    </form>
</div>

<!-- Main Application -->
<div class="app-wrapper" id="mainContainer">
    <div class="app-header">
        <h1>Menu Tally & Noteboard</h1>
        <div class="app-header-right">
            <span id="userEmail"></span>
            <button class="logout-btn" id="logoutBtn">Sign Out</button>
        </div>
    </div>

    <div class="main-layout">
        <!-- Side Menu: one button per unit -->
        <div class="side-menu">
            <div class="side-menu-title">Unit / Floor Tallies</div>
            <div class="side-menu-list" id="sideMenuList">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Content: PDF viewer + upload + noteboard -->
        <div class="content-area">
            <!-- PDF section -->
            <div class="section-card" id="pdfSection">
                <div class="section-title">Menu Item Tally</div>
                <div class="section-body">
                    <div class="no-selection" id="noSelection">
                        <h3>Select a unit from the menu</h3>
                        <p>Click on a unit/floor to view or upload its menu item tally PDF.</p>
                    </div>

                    <div id="unitDetail" style="display:none;">
                        <div class="pdf-detail-header" id="pdfDetailHeader">
                            <h2 id="detailUnitName"></h2>
                            <div class="time-range" id="detailTimeRange"></div>
                            <div class="upload-meta" id="detailUploadMeta"></div>
                        </div>

                        <div class="upload-area" id="uploadArea">
                            <h3>Upload PDF for this unit</h3>
                            <p>Drag & drop or click to browse (PDF only)</p>
                            <input type="file" id="fileInput" accept=".pdf" multiple style="display:none;">
                        </div>
                        <div class="upload-status" id="uploadStatus"></div>

                        <div class="pdf-viewer" id="pdfViewer">
                            <div class="pdf-pages-container" id="pdfPagesContainer"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Needs Attention Noteboard -->
            <div class="section-card">
                <div class="section-title">Needs Attention</div>
                <div class="section-body">
                    <div class="noteboard-list" id="noteboardList">
                        <div class="no-notes">Loading notes...</div>
                    </div>
                    <div class="noteboard-input-row">
                        <textarea id="noteInput" maxlength="250" placeholder="Enter a note (250 characters max)..."></textarea>
                        <button id="addNoteBtn">Post</button>
                    </div>
                    <div class="char-count" id="charCount">0 / 250</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBKqak1hp_64YjINjBf3zNaq0kJbu1AhWM",
        authDomain: "meal-schedule-5b1f4.firebaseapp.com",
        databaseURL: "https://meal-schedule-5b1f4-default-rtdb.firebaseio.com",
        projectId: "meal-schedule-5b1f4",
        storageBucket: "meal-schedule-5b1f4.firebasestorage.app",
        messagingSenderId: "796389771102",
        appId: "1:796389771102:web:dd5300418c2a4fbb84f1cf",
        measurementId: "G-XL8ZJ1RYLH"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Unit data from livetimesheet (time range, unit name)
    const unitData = [
        { time: "04:20 PM - 04:50 PM", name: "8South", color: "green" },
        { time: "04:10 PM - 04:40 PM", name: "8 Central", color: "yellow" },
        { time: "04:10 PM - 04:40 PM", name: "5 Central", color: "yellow" },
        { time: "04:20 PM - 04:50 PM", name: "5WN ICU", color: "green" },
        { time: "04:25 PM - 04:55 PM", name: "10 Central", color: "green" },
        { time: "04:35 PM - 05:05 PM", name: "5 West", color: "green" },
        { time: "04:40 PM - 05:10 PM", name: "9 South", color: "yellow" },
        { time: "04:50 PM - 05:20 PM", name: "6 Central", color: "yellow" },
        { time: "04:45 PM - 05:15 PM", name: "4 Central", color: "green" },
        { time: "04:50 PM - 05:20 PM", name: "7F ICU", color: "green" },
        { time: "04:50 PM - 05:20 PM", name: "7E ICU", color: "green" },
        { time: "04:55 PM - 05:25 PM", name: "7N ICU", color: "green" },
        { time: "05:15 PM - 05:45 PM", name: "10 WEST OBS", color: "yellow" },
        { time: "05:20 PM - 05:50 PM", name: "PEDIATRICS", color: "yellow" },
        { time: "05:45 PM - 06:15 PM", name: "2FMB", color: "green" },
        { time: "05:25 PM - 05:55 PM", name: "LABOR & DELIVERY", color: "yellow" },
        { time: "05:30 PM - 06:00 PM", name: "ANTEPARTUM & NICU", color: "yellow" },
        { time: "05:30 PM - 06:00 PM", name: "9 WEST", color: "green" },
        { time: "05:55 PM - 06:25 PM", name: "7S ICU", color: "yellow" },
        { time: "05:55 PM - 06:25 PM", name: "7SOUTH NEUROSTROKE", color: "yellow" },
        { time: "05:40 PM - 06:10 PM", name: "9 Central", color: "green" },
        { time: "", name: "Emergency Department", color: "green" },
        { time: "06:15 PM - 06:45 PM", name: "8 WEST ONCOLOGY", color: "yellow" }
    ];

    // Generate a Firebase-safe key from unit name
    function unitKey(name) {
        return name.replace(/[.#$/\[\]]/g, '_').replace(/\s+/g, '_');
    }

    let selectedUnitIndex = null;
    let unitPdfStatus = {}; // tracks which units have uploads

    // ---- AUTH ----
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            showMainApp(user);
            buildSideMenu();
            listenForAllUnitPdfs();
            loadNoteboard();
        } else {
            currentUser = null;
            showLogin();
        }
    });

    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const message = document.getElementById('loginMessage');

        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing in...';
        message.classList.remove('show', 'error');

        try {
            await auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value);
        } catch (error) {
            let errorMessage = 'Invalid email or password. Please try again.';
            if (error.code === 'auth/invalid-email') {
                errorMessage = 'Please enter a valid email address.';
            } else if (error.code === 'auth/too-many-requests') {
                errorMessage = 'Too many failed attempts. Please try again later.';
            }
            message.textContent = errorMessage;
            message.classList.add('show', 'error');
            loginBtn.disabled = false;
            loginBtn.textContent = 'Sign In';
            passwordInput.value = '';
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', async function() {
        try { await auth.signOut(); } catch (e) { /* silent */ }
    });

    function showLogin() {
        document.getElementById('loginContainer').style.display = 'block';
        document.getElementById('mainContainer').classList.remove('show');
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        document.getElementById('loginBtn').disabled = false;
        document.getElementById('loginBtn').textContent = 'Sign In';
    }

    function showMainApp(user) {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').classList.add('show');
        document.getElementById('userEmail').textContent = user.email;
    }

    // ---- SIDE MENU ----
    function buildSideMenu() {
        const list = document.getElementById('sideMenuList');
        list.innerHTML = '';
        // "All Selections" button at the top
        const allBtn = document.createElement('button');
        allBtn.className = 'unit-btn';
        allBtn.dataset.index = 'all';
        const allDot = document.createElement('span');
        allDot.className = 'has-pdf';
        allDot.style.background = '#1a3c8b';
        const allLabel = document.createElement('span');
        allLabel.className = 'btn-label';
        allLabel.style.fontWeight = '600';
        allLabel.textContent = 'All Selections';
        allBtn.appendChild(allDot);
        allBtn.appendChild(allLabel);
        allBtn.addEventListener('click', () => selectAllUnits());
        list.appendChild(allBtn);

        unitData.forEach((unit, idx) => {
            const btn = document.createElement('button');
            btn.className = 'unit-btn';
            btn.dataset.index = idx;

            const dot = document.createElement('span');
            dot.className = 'no-pdf';
            dot.id = 'dot-' + idx;

            const label = document.createElement('span');
            label.className = 'btn-label';
            label.textContent = unit.name;

            btn.appendChild(dot);
            btn.appendChild(label);
            btn.addEventListener('click', () => selectUnit(idx));
            list.appendChild(btn);
        });
    }

    function selectUnit(idx) {
        selectedUnitIndex = idx;
        const unit = unitData[idx];
        const key = unitKey(unit.name);

        // Highlight active button
        document.querySelectorAll('.unit-btn').forEach((b, i) => {
            b.classList.toggle('active', i === idx);
        });

        // Show detail area
        document.getElementById('noSelection').style.display = 'none';
        document.getElementById('unitDetail').style.display = 'block';

        // Show upload area (may have been hidden by "All" view)
        document.getElementById('uploadArea').style.display = '';

        // Set header info
        document.getElementById('detailUnitName').textContent = unit.name;
        document.getElementById('detailTimeRange').textContent = unit.time
            ? 'Dinner Delivery Window: ' + unit.time
            : 'No scheduled delivery window';
        document.getElementById('detailUploadMeta').textContent = '';

        // Clear previous PDF
        document.getElementById('pdfViewer').classList.remove('show');
        document.getElementById('pdfPagesContainer').innerHTML = '';
        document.getElementById('uploadStatus').className = 'upload-status';
        document.getElementById('uploadStatus').innerHTML = '';

        // Load PDF if exists
        loadUnitPdf(key);
    }

    function selectAllUnits() {
        selectedUnitIndex = null;

        // Highlight "All Selections" button
        document.querySelectorAll('.unit-btn').forEach((b) => {
            b.classList.toggle('active', b.dataset.index === 'all');
        });

        // Show detail area
        document.getElementById('noSelection').style.display = 'none';
        document.getElementById('unitDetail').style.display = 'block';

        // Set header
        document.getElementById('detailUnitName').textContent = 'All Floors Menu Item Tally';
        document.getElementById('detailTimeRange').textContent = '';
        document.getElementById('detailUploadMeta').textContent = '';

        // Hide upload area for "all" view
        document.getElementById('uploadArea').style.display = 'none';
        document.getElementById('uploadStatus').className = 'upload-status';
        document.getElementById('uploadStatus').innerHTML = '';

        // Load all PDFs
        const container = document.getElementById('pdfPagesContainer');
        const viewer = document.getElementById('pdfViewer');
        container.innerHTML = '<div style="padding:12px;color:#666;"><span class="spinner-small"></span> Loading all tallies...</div>';
        viewer.classList.add('show');

        db.ref('menuTallyUnits').once('value', async (snapshot) => {
            const allData = snapshot.val() || {};
            container.innerHTML = '';

            let anyRendered = false;
            for (const unit of unitData) {
                const key = unitKey(unit.name);
                const data = allData[key];
                if (data && data.files && data.files.length > 0) {
                    // Unit heading
                    const heading = document.createElement('div');
                    heading.style.cssText = 'width:100%;padding:10px 14px 4px;font-size:15px;font-weight:600;color:#1a3c8b;';
                    heading.textContent = unit.name;
                    container.appendChild(heading);

                    for (const file of data.files) {
                        try {
                            const pdfData = atob(file.data.split(',')[1]);
                            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const scale = 1.5;
                                const viewport = page.getViewport({ scale });
                                const canvas = document.createElement('canvas');
                                canvas.width = viewport.width;
                                canvas.height = viewport.height;
                                const ctx = canvas.getContext('2d');
                                await page.render({ canvasContext: ctx, viewport }).promise;
                                container.appendChild(canvas);
                            }
                            anyRendered = true;
                        } catch (err) {
                            const errDiv = document.createElement('div');
                            errDiv.style.cssText = 'color:#721c24;padding:12px;';
                            errDiv.textContent = 'Error rendering ' + file.name;
                            container.appendChild(errDiv);
                        }
                    }
                }
            }

            if (!anyRendered) {
                container.innerHTML = '<div style="padding:20px;color:#999;text-align:center;">No PDFs uploaded yet.</div>';
            }
        });
    }

    // ---- PDF UPLOAD & STORAGE ----
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleFiles(e.target.files);
        fileInput.value = '';
    });

    async function handleFiles(files) {
        if (selectedUnitIndex === null) return;
        const pdfFiles = Array.from(files).filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));
        if (pdfFiles.length === 0) {
            showUploadStatus('Please select PDF files only.', 'error');
            return;
        }

        const unit = unitData[selectedUnitIndex];
        const key = unitKey(unit.name);

        showUploadStatus('<span class="spinner-small"></span> Uploading...', '');

        try {
            const fileDataArray = [];
            for (const file of pdfFiles) {
                const base64 = await readFileAsBase64(file);
                fileDataArray.push({ name: file.name, data: base64, size: file.size });
            }

            const entry = {
                files: fileDataArray,
                uploadedBy: currentUser.email,
                uploadedAt: firebase.database.ServerValue.TIMESTAMP
            };

            await db.ref('menuTallyUnits/' + key).set(entry);
            showUploadStatus('Upload complete.', 'success');
            loadUnitPdf(key);
        } catch (err) {
            showUploadStatus('Upload failed. File may be too large (max ~5MB).', 'error');
        }
    }

    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(reader.error);
            reader.readAsDataURL(file);
        });
    }

    function showUploadStatus(msg, type) {
        const el = document.getElementById('uploadStatus');
        el.innerHTML = msg;
        el.className = 'upload-status show' + (type ? ' ' + type : '');
    }

    function loadUnitPdf(key) {
        db.ref('menuTallyUnits/' + key).once('value', async (snapshot) => {
            const data = snapshot.val();
            if (data && data.files && data.files.length > 0) {
                const dateStr = data.uploadedAt ? new Date(data.uploadedAt).toLocaleString() : '';
                document.getElementById('detailUploadMeta').textContent =
                    'Uploaded by ' + (data.uploadedBy || 'Unknown') + (dateStr ? ' on ' + dateStr : '');
                await displayPdf(data);
            } else {
                document.getElementById('detailUploadMeta').textContent = 'No PDF uploaded yet.';
                document.getElementById('pdfViewer').classList.remove('show');
            }
        });
    }

    async function displayPdf(data) {
        const container = document.getElementById('pdfPagesContainer');
        const viewer = document.getElementById('pdfViewer');
        container.innerHTML = '';
        viewer.classList.add('show');

        for (const file of data.files) {
            try {
                const pdfData = atob(file.data.split(',')[1]);
                const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const scale = 1.5;
                    const viewport = page.getViewport({ scale });
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    const ctx = canvas.getContext('2d');
                    await page.render({ canvasContext: ctx, viewport }).promise;
                    container.appendChild(canvas);
                }
            } catch (err) {
                const errDiv = document.createElement('div');
                errDiv.style.cssText = 'color:#721c24;padding:12px;';
                errDiv.textContent = 'Error rendering ' + file.name;
                container.appendChild(errDiv);
            }
        }
    }

    // Listen for all unit PDF presence to show green/gray dots
    function listenForAllUnitPdfs() {
        db.ref('menuTallyUnits').on('value', (snapshot) => {
            const allData = snapshot.val() || {};
            unitData.forEach((unit, idx) => {
                const key = unitKey(unit.name);
                const dot = document.getElementById('dot-' + idx);
                if (dot) {
                    const hasPdf = allData[key] && allData[key].files && allData[key].files.length > 0;
                    dot.className = hasPdf ? 'has-pdf' : 'no-pdf';
                }
            });
        });
    }

    // ---- NOTEBOARD ----
    const noteInput = document.getElementById('noteInput');
    const addNoteBtn = document.getElementById('addNoteBtn');
    const charCount = document.getElementById('charCount');

    noteInput.addEventListener('input', () => {
        const len = noteInput.value.length;
        charCount.textContent = len + ' / 250';
        charCount.className = 'char-count' + (len > 250 ? ' over' : '');
    });

    addNoteBtn.addEventListener('click', async () => {
        const text = noteInput.value.trim().substring(0, 250).replace(/[\x00-\x1F\x7F]/g, '');
        if (!text || !currentUser) return;

        addNoteBtn.disabled = true;
        try {
            await db.ref('needsAttentionNotes').push({
                text: text,
                author: currentUser.email,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
            noteInput.value = '';
            charCount.textContent = '0 / 250';
        } catch (err) {
            alert('Failed to post note.');
        }
        addNoteBtn.disabled = false;
    });

    function loadNoteboard() {
        const noteboardList = document.getElementById('noteboardList');
        db.ref('needsAttentionNotes').orderByChild('createdAt').on('value', (snapshot) => {
            noteboardList.innerHTML = '';
            const notes = [];
            snapshot.forEach((child) => {
                notes.push({ key: child.key, ...child.val() });
            });

            if (notes.length === 0) {
                noteboardList.innerHTML = '<div class="no-notes">No notes yet. Be the first to add one.</div>';
                return;
            }

            notes.reverse().forEach((note) => {
                const div = document.createElement('div');
                div.className = 'noteboard-item';

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'note-delete';
                deleteBtn.textContent = 'x';
                deleteBtn.title = 'Delete note';
                deleteBtn.onclick = () => {
                    if (confirm('Delete this note?')) {
                        db.ref('needsAttentionNotes/' + note.key).remove();
                    }
                };

                const textSpan = document.createElement('span');
                textSpan.textContent = note.text;

                const meta = document.createElement('div');
                meta.className = 'note-meta';
                const dateStr = note.createdAt ? new Date(note.createdAt).toLocaleString() : '';
                meta.textContent = (note.author || 'Unknown') + (dateStr ? ' â€” ' + dateStr : '');

                div.appendChild(deleteBtn);
                div.appendChild(textSpan);
                div.appendChild(meta);
                noteboardList.appendChild(div);
            });
        });
    }
</script>
</body>
</html>
