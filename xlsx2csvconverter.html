<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DimTools - XLSX to CSV Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url("https://unpkg.com/papercss@1.9.2/dist/paper.css");
        
        /* Navigation styling matching the template */
        li:has(~ .current)::after {
            content: "/";
            margin-inline-start: 10px;
        }

        li:has(~ li:not(a))::after {
            content: "/";
            margin-inline-start: 10px;
        }

        body {
            display: grid;
            place-items: center;
            min-height: 100vh;
            background-color: #f6eee3;
            background-size: 20px 20px;
            background-image: repeating-linear-gradient(0deg, #e5decf, #e5decf 1px, #f6eee3 1px, #f6eee3);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        ul {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        ul li::before {
            content: "";
        }
        
        /* Main container */
        .container {
            width: 100%;
            max-width: 1200px;
            min-height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* Upload area styling */
        .upload-area {
            background: white;
            border-radius: 5px;
            padding: 2rem;
            text-align: center;
            border: 2px dashed #8b4513;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #f9f5eb;
            border-color: #a0522d;
        }
        
        .upload-area.dragover {
            background: #f0e6d6;
            border-color: #8b4513;
            border-style: solid;
        }
        
        /* Conversion options */
        .options-area {
            background: white;
            border-radius: 5px;
            padding: 1.5rem;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .options-area.active {
            display: block;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .option-group {
            margin-bottom: 1rem;
        }
        
        .option-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #8b4513;
        }
        
        .option-group select, .option-group input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #e5decf;
            border-radius: 3px;
            font-family: inherit;
        }
        
        /* Sheets selection */
        .sheets-area {
            background: white;
            border-radius: 5px;
            padding: 1.5rem;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .sheets-area.active {
            display: block;
        }
        
        .sheets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background: #f9f5eb;
            border-radius: 3px;
        }
        
        .sheet-card {
            background: white;
            border: 2px solid #e5decf;
            border-radius: 5px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .sheet-card:hover {
            border-color: #8b4513;
            background: #f9f5eb;
        }
        
        .sheet-card.selected {
            border-color: #8b4513;
            background: #8b4513;
            color: white;
        }
        
        .sheet-name {
            font-weight: bold;
            margin-bottom: 0.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .sheet-info {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        /* Results area */
        .results-area {
            background: white;
            border-radius: 5px;
            padding: 1.5rem;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .results-area.active {
            display: block;
        }
        
        .results-preview {
            background: #f9f5eb;
            border: 1px solid #e5decf;
            border-radius: 5px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            margin-top: 1rem;
        }
        
        /* Button groups */
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .button-group button {
            flex: 1;
            min-width: 150px;
        }
        
        /* Status messages */
        .status-message {
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .status-message.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            display: block;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 1rem;
            color: #666;
            font-size: 0.9rem;
            margin-top: auto;
        }
        
        /* Instructions */
        .instructions {
            background: white;
            border-radius: 5px;
            padding: 1.5rem;
            margin-top: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .instructions h3 {
            color: #8b4513;
            margin-top: 0;
        }
        
        .instructions ul {
            display: block;
            margin-left: 1.5rem;
        }
        
        .instructions li {
            margin-bottom: 0.5rem;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #8b4513;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                height: auto;
                min-height: calc(100vh - 120px);
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group button {
                width: 100%;
            }
            
            .sheets-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <ul class="paper border shadow large-shadow shadow-hover">
            <li><a href="csvmatcher.html">CSV Row Matcher</a></li>
            <li><a href="xlsxviewer.html">XLSX Viewer</a></li>
            <li class="current"><a href="#">XLSX to CSV</a></li>
            <li><a href="about.html">What is DimTools?</a></li>
        </ul>
        
        <div id="uploadArea" class="upload-area paper border shadow">
            <h2>üîÑ XLSX to CSV Converter</h2>
            <p>Drag & drop an Excel file here or click to browse</p>
            <p><small>Supported file types: .xlsx, .xls</small></p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
        </div>
        
        <div id="sheetsArea" class="sheets-area">
            <h3>Select Sheets to Convert</h3>
            <p>Choose which sheets you want to convert to CSV:</p>
            <div class="sheets-grid" id="sheetsGrid"></div>
            <div class="button-group">
                <button class="btn-secondary" onclick="selectAllSheets()">Select All</button>
                <button class="btn-secondary" onclick="deselectAllSheets()">Deselect All</button>
            </div>
        </div>
        
        <div id="optionsArea" class="options-area">
            <h3>Conversion Options</h3>
            <div class="options-grid">
                <div class="option-group">
                    <label for="delimiter">Field Delimiter</label>
                    <select id="delimiter">
                        <option value="," selected>Comma ( , )</option>
                        <option value=";">Semicolon ( ; )</option>
                        <option value="\t">Tab ( \t )</option>
                        <option value="|">Pipe ( | )</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="encoding">Text Encoding</label>
                    <select id="encoding">
                        <option value="utf-8" selected>UTF-8 (Recommended)</option>
                        <option value="windows-1252">Windows-1252</option>
                        <option value="iso-8859-1">ISO-8859-1</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="includeHeaders">Include Headers</label>
                    <select id="includeHeaders">
                        <option value="yes" selected>Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="quoteFields">Quote Fields</label>
                    <select id="quoteFields">
                        <option value="auto" selected>Auto (when needed)</option>
                        <option value="all">Always</option>
                        <option value="none">Never</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
        
        <div id="resultsArea" class="results-area">
            <h3>Conversion Results</h3>
            <div class="button-group">
                <button class="btn-primary" onclick="downloadSelectedSheets()">Download Selected</button>
                <button class="btn-secondary" onclick="downloadAllAsZip()">Download All as ZIP</button>
                <button class="btn-secondary" onclick="resetConverter()">Convert Another File</button>
            </div>
            
            <h4 style="margin-top: 1.5rem;">Preview of first selected sheet:</h4>
            <div class="results-preview" id="resultsPreview"></div>
        </div>
        
        <div class="instructions paper border shadow">
            <h3>How to use this XLSX to CSV Converter</h3>
            <ul>
                <li>Upload an Excel file (.xlsx or .xls format) using the drag & drop area</li>
                <li>Select which sheets you want to convert (you can choose multiple)</li>
                <li>Configure CSV options like delimiter, encoding, and headers</li>
                <li>Download individual CSV files or all sheets as a ZIP archive</li>
                <li>All processing happens locally in your browser - no data is uploaded to any server</li>
                <li>Supports large spreadsheets with multiple sheets</li>
            </ul>
        </div>
        
        <div class="footer">
            <p>DimTools - Local Browser XLSX to CSV Converter | All data stays on your device</p>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <h3>Processing Excel file...</h3>
        <p>This may take a moment for large files</p>
    </div>

    <script>
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const sheetsArea = document.getElementById('sheetsArea');
        const sheetsGrid = document.getElementById('sheetsGrid');
        const optionsArea = document.getElementById('optionsArea');
        const resultsArea = document.getElementById('resultsArea');
        const statusMessage = document.getElementById('statusMessage');
        const resultsPreview = document.getElementById('resultsPreview');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // State variables
        let workbook = null;
        let selectedSheets = new Set();
        let csvData = {};
        
        // Event Listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        // Handle the uploaded file
        function handleFile(file) {
            // Check if it's an Excel file
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showStatus('Please upload an Excel file (.xlsx or .xls)', 'error');
                return;
            }
            
            // Check if SheetJS is available
            if (typeof XLSX === 'undefined') {
                showStatus('Error: Spreadsheet library failed to load. Please refresh the page.', 'error');
                return;
            }
            
            // Show loading overlay
            loadingOverlay.classList.add('active');
            
            // Parse the Excel file
            parseExcelFile(file);
        }
        
        // Parse Excel file
        function parseExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, {type: 'array'});
                    
                    // Display sheets for selection
                    displaySheets(workbook.SheetNames);
                    
                    // Update UI
                    uploadArea.style.display = 'none';
                    sheetsArea.classList.add('active');
                    optionsArea.classList.add('active');
                    
                    showStatus(`‚úÖ Successfully loaded workbook with ${workbook.SheetNames.length} sheet(s)`, 'success');
                    
                } catch (error) {
                    showStatus(`‚ùå Error parsing Excel file: ${error.message}`, 'error');
                } finally {
                    loadingOverlay.classList.remove('active');
                }
            };
            
            reader.onerror = function() {
                showStatus('‚ùå Error reading file. Please try again.', 'error');
                loadingOverlay.classList.remove('active');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Display sheets for selection
        function displaySheets(sheetNames) {
            sheetsGrid.innerHTML = '';
            
            sheetNames.forEach((sheetName, index) => {
                const sheet = workbook.Sheets[sheetName];
                const range = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
                const rowCount = range.e.r - range.s.r + 1;
                const colCount = range.e.c - range.s.c + 1;
                
                const sheetCard = document.createElement('div');
                sheetCard.className = 'sheet-card';
                sheetCard.innerHTML = `
                    <div class="sheet-name">${sheetName}</div>
                    <div class="sheet-info">${rowCount} rows √ó ${colCount} cols</div>
                `;
                
                sheetCard.addEventListener('click', () => {
                    toggleSheetSelection(sheetName, sheetCard);
                });
                
                sheetsGrid.appendChild(sheetCard);
                
                // Auto-select first sheet
                if (index === 0) {
                    toggleSheetSelection(sheetName, sheetCard);
                }
            });
        }
        
        // Toggle sheet selection
        function toggleSheetSelection(sheetName, sheetCard) {
            if (selectedSheets.has(sheetName)) {
                selectedSheets.delete(sheetName);
                sheetCard.classList.remove('selected');
            } else {
                selectedSheets.add(sheetName);
                sheetCard.classList.add('selected');
            }
            
            // Enable/disable convert button based on selection
            updateConvertButton();
        }
        
        // Select all sheets
        function selectAllSheets() {
            const sheetCards = sheetsGrid.querySelectorAll('.sheet-card');
            selectedSheets = new Set(workbook.SheetNames);
            
            sheetCards.forEach(card => {
                card.classList.add('selected');
            });
            
            updateConvertButton();
        }
        
        // Deselect all sheets
        function deselectAllSheets() {
            const sheetCards = sheetsGrid.querySelectorAll('.sheet-card');
            selectedSheets.clear();
            
            sheetCards.forEach(card => {
                card.classList.remove('selected');
            });
            
            updateConvertButton();
        }
        
        // Update convert button state
        function updateConvertButton() {
            // This function would update any convert button state if needed
        }
        
        // Convert selected sheets to CSV
        function convertSheets() {
            if (selectedSheets.size === 0) {
                showStatus('‚ùå Please select at least one sheet to convert', 'error');
                return;
            }
            
            loadingOverlay.classList.add('active');
            showStatus('‚è≥ Converting sheets to CSV...', 'processing');
            
            // Get conversion options
            const delimiter = document.getElementById('delimiter').value;
            const encoding = document.getElementById('encoding').value;
            const includeHeaders = document.getElementById('includeHeaders').value === 'yes';
            const quoteFields = document.getElementById('quoteFields').value;
            
            // Convert selected sheets
            csvData = {};
            let previewContent = '';
            
            selectedSheets.forEach(sheetName => {
                try {
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Get CSV conversion options
                    const csvOptions = {
                        FS: delimiter,
                        RS: '\n',
                        strip: false,
                        blankrows: false,
                        skipHidden: false,
                        forceQuotes: quoteFields === 'all'
                    };
                    
                    // Convert to CSV
                    let csv = XLSX.utils.sheet_to_csv(worksheet, csvOptions);
                    
                    // Remove headers if needed
                    if (!includeHeaders) {
                        const lines = csv.split('\n');
                        lines.shift(); // Remove header line
                        csv = lines.join('\n');
                    }
                    
                    // Store CSV data
                    csvData[sheetName] = csv;
                    
                    // Build preview from first sheet
                    if (!previewContent && csv) {
                        const previewLines = csv.split('\n').slice(0, 20);
                        previewContent = previewLines.join('\n');
                        if (csv.split('\n').length > 20) {
                            previewContent += '\n... (truncated)';
                        }
                    }
                    
                } catch (error) {
                    showStatus(`‚ùå Error converting sheet ${sheetName}: ${error.message}`, 'error');
                }
            });
            
            // Update UI
            loadingOverlay.classList.remove('active');
            sheetsArea.classList.remove('active');
            optionsArea.classList.remove('active');
            resultsArea.classList.add('active');
            
            // Show preview
            resultsPreview.textContent = previewContent || 'No data available for preview';
            
            showStatus(`‚úÖ Successfully converted ${selectedSheets.size} sheet(s) to CSV`, 'success');
        }
        
        // Download selected sheets
        function downloadSelectedSheets() {
            if (Object.keys(csvData).length === 0) {
                showStatus('‚ùå No data to download. Please convert sheets first.', 'error');
                return;
            }
            
            // For single sheet, download directly
            if (Object.keys(csvData).length === 1) {
                const sheetName = Object.keys(csvData)[0];
                downloadCSV(sheetName, csvData[sheetName]);
                return;
            }
            
            // For multiple sheets, download sequentially
            showStatus('üì• Downloading CSV files...', 'processing');
            
            let index = 0;
            const sheets = Object.keys(csvData);
            
            function downloadNext() {
                if (index < sheets.length) {
                    const sheetName = sheets[index];
                    downloadCSV(sheetName, csvData[sheetName]);
                    index++;
                    
                    // Small delay between downloads
                    if (index < sheets.length) {
                        setTimeout(downloadNext, 300);
                    } else {
                        showStatus(`‚úÖ Downloaded ${sheets.length} CSV file(s)`, 'success');
                    }
                }
            }
            
            downloadNext();
        }
        
        // Download as ZIP (simulated - actually downloads individually)
        function downloadAllAsZip() {
            if (Object.keys(csvData).length === 0) {
                showStatus('‚ùå No data to download. Please convert sheets first.', 'error');
                return;
            }
            
            showStatus('üì¶ Preparing ZIP download...', 'processing');
            
            // In a real implementation, you would use a ZIP library like JSZip
            // For simplicity, we'll download all files with a common prefix
            
            let index = 0;
            const sheets = Object.keys(csvData);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            
            function downloadNext() {
                if (index < sheets.length) {
                    const sheetName = sheets[index];
                    const csvContent = csvData[sheetName];
                    const filename = `converted_${timestamp}_${sheetName}.csv`;
                    
                    downloadCSV(filename, csvContent);
                    index++;
                    
                    if (index < sheets.length) {
                        setTimeout(downloadNext, 300);
                    } else {
                        showStatus(`‚úÖ Downloaded ${sheets.length} files with timestamp prefix`, 'success');
                    }
                }
            }
            
            downloadNext();
        }
        
        // Download CSV file
        function downloadCSV(filename, csvContent) {
            const encoding = document.getElementById('encoding').value;
            let bom = '';
            
            if (encoding === 'utf-8') {
                bom = '\uFEFF'; // UTF-8 BOM
            }
            
            const blob = new Blob([bom + csvContent], { 
                type: `text/csv;charset=${encoding}`
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename.replace(/[^\w\-.]/g, '_'); // Sanitize filename
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Reset converter
        function resetConverter() {
            // Reset UI
            uploadArea.style.display = 'block';
            sheetsArea.classList.remove('active');
            optionsArea.classList.remove('active');
            resultsArea.classList.remove('active');
            statusMessage.className = 'status-message';
            statusMessage.textContent = '';
            resultsPreview.textContent = '';
            
            // Reset state
            workbook = null;
            selectedSheets.clear();
            csvData = {};
            sheetsGrid.innerHTML = '';
            fileInput.value = '';
        }
        
        // Show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Add convert button to options area
            const convertButton = document.createElement('button');
            convertButton.className = 'btn-primary';
            convertButton.textContent = 'üîÑ Convert to CSV';
            convertButton.style.marginTop = '1rem';
            convertButton.onclick = convertSheets;
            optionsArea.appendChild(convertButton);
        });
    </script>
</body>
</html>
